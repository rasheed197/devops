# SYSTEMCTL AND TOMCAT

In this lecture we'll learn about **systemctl** by using **apache tomcat**.

We have previously seen **httpd** service, and we know we can this service with systemctl command.

There are some services in which you don't get systemctl for them by default, so you should know how to build it for them.

**Tomcat** is a service from apache. Note that **apache httpd** and **apache tomcat** are two different services.

Tomcat is open source java servlet container. That means you can host java-based web applications by using tomcat service.

The main focus is **systemctl** and not apache tomcat.

Login to your CentOS VM.

Install httpd

```
$ dnf install httpd -y

#check http status
$ systemctl status httpd 
```

If you look at the configuration file for the systemctl command, You should see so many files including **httpd.service**. So this is the configuration file.
```
$ ls -l /usr/lib/systemd/system/
```



```
$ cat /usr/lib/systemd/system/httpd.service
```

If we check this httpd.service file, we should see 3 **directives**

- Unit
- Service
- Install

Focus on this setting in the **service directive**
```
ExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND 
```

This basically is the command to start **httpd** service. So when we say **systemctl httpd start**, it's going to execute this command **/usr/sbin/httpd $OPTIONS -DFOREGROUND**

So we install the httpd service through package manager **DNF**, and when that happens, thos will create all these files automatically. 

It's configuration package will be in **/etc/httpd**

It's logs will be in **/var/log/httpd**

It's library will be in **/usr/lib/httpd** etc.

So that's is managed by package manager like DNF. So we want to install **Apache Tomcat** service and that is not available through DNF command, and also we want to install a specific version.

- So google **apache tomcat 10** in your browser, 

```
URL: tomcat.apache.org/download-10.cgi
```

- Copy the link address of the tar.gz format
```
$ wget [LINK ADDRESS]
```

- Extract the file

```
$ ls

...    apache-tomcat.tar.gz   ...

$ tar xzvf apache-tomcat.tar.gz

$ ls 

...    apache-tomcat-10.1.28    ...
```

If we list everything in that folder, we should see the bin, logs, temp, conf, lib etc. and every other things in this folder. So we have the complete binary, complete package in this folder.

```
$ ls apache-tomcat-10.1.28

bin    temp    logs    conf    lib     ...
```

Apache tomcat needs a dependency **Java**, so we're first going to install java

```
$ dnf install java-17-openjdk -y

#check version
$ java --version
```

Now to start the tomcat service we make use of the shell script **startup.sh** in the apache tomcat folder

```
$ ls apache-tomcat-10.1.28/bin/

...    startup.sh     ...

$ cd apache-tomcat-10.1.28

$ bin/startup.sh

...
Tomcat started.
```

We also have a default apache tomcat webpage

```
http://192.168...
```

So we can start this service. So what are the problems

1. How do we enable this service at boot time?
2. To stop as well, we have a separate script.
3. In devops, there are so many automation tools, and these tools will execute commands remotely to start a service. We don't mention command in these tools, we just tell it to start a particular service e.g tomcat, and in the background it will execute **systemctl start tomcat**, and since it's not available we will not be able to start the tomcat service or manage it. 

So as a devop engineer it is not recommended to start a service like this

```
$ cd apache-tomcat-10.1.28

$ bin/startup.sh
```

### NOW LETS WRITE SYSTEMD FILE FOR TOR TOMCAT SERVICE

Tomcat as any other service should be run as non root user.

So we need a user that is going to run the tomcat processes, and we also need a home directory where we can keep our tomcat data.

```
$ useradd --home-dir /opt/tomcat --shell /sbin/nologin tomcat
```

- **/opt/tomcat**: Home directory. This is where we will copy all our tomcat binary files.

- **/sbin/nologin**: since this user **tomcat** is just to run the tomcat process, we do not want it to have any shell, so should not have a login (this is for security purpose).

Copy all the content in **apache-tomcat-10.1.28** to **/opt/tomcat**

```
$ cp -r apache-tomcat-10.1.28/* /opt/tomcat/
```

Make sure all the files and folders in **/opt/tomcat/** are owned by the tomcat user, else we'll get permission error.

```
$ chown -R tomat.tomcat /opt/tomcat/
```

Now let's create the systemd file

```
vim /etc/systemd/system/tomcat.service
```

So **tomcat** will be the name of the service, Example: **systemctl start tomcat**.

If you give any other name, that will be the name of the service Example if you give **/etc/systemd/system/tomc.service**, the service name will be **tomc** 

tomcat.service
```
[Unit]
Description=Tomcat 
After=network.target

[Service]
Type=forking
Group=tomcat
User=tomcat
WorkingDirectory=/opt/tomcat
Environment=JAVA_HOME=/usr/lib/jvm/jre

Environment=CATALINA_HOME=/opt/tomcat
Environment=CATALINE_BASE=/opt/tomcat

ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh

[Install]
WantedBy=multi-user.target

```
In the **Unit** we give global things like description and dependencies (After)

**After=network.target**: After all the network service get started, then only should tomcat be started. That's a dependency.

In the service, first we mention the user that'll run this service

This variable **JAVA_HOME** has nothing to do with systemd file. These are the requirements of the tomcat service, same with **CATALINA_HOME** and **CATALINA_BASE**. If you want to start the tomcat service and we want to use java of a specific version or location, you can do **JAVA_HOME=[PATH]**. Our java by default will be installed at **/usr/lib/jvm/jre**

So in systemd, if we want to export variable we say **Environment=[VARIABLE NAME]=[VALUE]**

**CATALINA_HOME** and **CATALINA_BASE**: Home directory of tomcat

**ExecStart** and **ExecStop**: Executable file to start and stop the service. So we provide the location.

**Type=forking**: forking in process means the process that start child processes 

**WantedBy=multi-user.target**: This is systemadmin stuff. We have kind of a safe mode and we have kind of a non gui mode where all of the services are started except for the gui, and then there is the gui mode. So **multi-user.target** is the non gui mode of the operating system where all the services starts, it's not the safe mode, it's not the gui, it the complete operating system startup but minus the gui (graphical user interface). So we want the service to run in **multi-user.target**, which is what happens when we do **vagrant up**, the operating system starts but there's no gui, but all the services starts, that's the **multi-user.target**

Save and quit the file.

When you make any changes in the systemd file, you have to run this command

```
$ systemctl daemon-reload
```

Make sure no tomcat process is running before, if it is, kill it. Now let's start tomcat

```
$ systemctl start tomcat

$ systemctl status tomcat

$ systemctl enabled tomacat
```






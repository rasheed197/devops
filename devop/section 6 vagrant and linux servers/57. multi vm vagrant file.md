# MULTI VM VAGRANT FILE

If we look at our VM setup, we have our folder and we have a Vagranfile in that folder

```
centos 
    .vagrant 
    Vagranfile 
```

So you can have one VM per folder. If you want multiple VMs, then you need to manage different folders, and you need to manage them with different commands.

It will be very convenient if we can manage multiple VMs from one single Vagranfile. This would be specially for an application stack that needs multiple services running in multiple VMs. Like database on a separate VM, application service on a separate VM, frontend service on a separate VM, but together they work and form one single application. In such cases you need to create a multi VM Vagranfile.

If you visit the vagrant documentation website, and click on the **Multi-Machine** tab, you will see an example of a multi VM Vagranfile 


```
vagrant.configure("2") do |config|

  config.vm.provision "shell", inline: "echo Hello"

  config.vm.define "web" do |web|
    web.vm.box = "apache"
  end

  config.vm.define "db" do |db|
    db.vm.box = "mysql"
  end

end
```

From the above, we have 2 VMs **web** and **db**, **apache** and **db** are the name of the box. This way we can have multiple VMs, we just have to add

```
...
config.vm.define "[VM NAME]" do |[name]|
  [name].vm.box = "[BOX NAME]"
end
...
```

You can also create multi VM Vagrantfile using ChatGPT, example

**multi VM Vagranfile with web01 ubuntu20, web02 with ubuntu20, and db01 with CentOS9. Private IP for all the VMs, provisioning for db01, set hostname also.**

```
Vagrant.configure("2") do |config|
  # Global config
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "1024"
    # vb.cpus = 1
  end

  # -------------------------
  # Web Server 01 (Ubuntu 20.04)
  # -------------------------
  config.vm.define "web01" do |web01|
    web01.vm.box = "ubuntu/focal64"
    web01.vm.hostname = "web01.local"

    web01.vm.network "private_network", ip: "192.168.56.11"

    # Optional: provisioning
    # web01.vm.provision "shell", inline: <<-SHELL
      # apt-get update -y
      # apt-get install -y nginx
      # systemctl enable nginx
    # SHELL
  end

  # -------------------------
  # Web Server 02 (Ubuntu 20.04)
  # -------------------------
  config.vm.define "web02" do |web02|
    web02.vm.box = "ubuntu/focal64"
    web02.vm.hostname = "web02.local"

    web02.vm.network "private_network", ip: "192.168.56.12"

    # Optional: provisioning
    # web02.vm.provision "shell", inline: <<-SHELL
      # apt-get update -y
      # apt-get install -y nginx
      # systemctl enable nginx
    # SHELL
  end

  # -------------------------
  # DB Server (CentOS Stream 9)
  # -------------------------
  config.vm.define "db01" do |db01|
    db01.vm.box = "generic/centos9s"
    db01.vm.hostname = "db01.local"

    db01.vm.network "private_network", ip: "192.168.56.13"

    # Provisioning for DB server
    db01.vm.provision "shell", inline: <<-SHELL
      dnf install -y mariadb-server wget unzip -y
      systemctl enable mariadb
      systemctl start mariadb

      # Optional: security setup
      # mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'rootpass';"
    SHELL
  end
end
```

In your VSCode, Create folder **/c/vagrant-vms/multivm** and inside a file **Vagrantfile** and paste the code inside.

```
/c/vagrant-vms/
    multivm/
    Vagranfile 
``` 

Before running the vagrant up command, make sure all the other VMs are powered off or destroyed.

Now if you want to manage this VMs you do it using their name

```
#power on all VM
$ vagrant up

#power on one VM e.g web01
$ vagrant up web01

#shut down all VMs 
$ power halt

#shut down one VM e.g web02
$ vagrant up web02

#destroy all VMs
$ vagrant destroy 

# destroy one VM 
$ vagrant destroy db01

#login to VM 
vagrant ssh web01
```

If you need to add another VM in the vagrant file, you just have to duplcate

```
Vagrant.configure("2") do |config|

...

# -------------------------
  # Web Server 03 (Ubuntu 20.04)
  # -------------------------
  config.vm.define "web03" do |web01|
    web03.vm.box = "ubuntu/focal64"
    web03.vm.hostname = "web03.local"

    web03.vm.network "private_network", ip: "192.168.56.14"

    # Optional: provisioning
    # web03.vm.provision "shell", inline: <<-SHELL
      # apt-get update -y
      # apt-get install -y nginx
      # systemctl enable nginx
    # SHELL
  end

...

end
```

Now to create the VM you just have to run

```
$ vagrant up web03
```

Once you are done, you can destroy the VMs 

```
$ vagrant destroy --force
```

With **--force** it won't ask you any questions.














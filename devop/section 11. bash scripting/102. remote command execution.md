# REMOTE COMMAND EXECUTION

In this lecture we will look at how we can execute command from scriptbox to web01, web02 and web03. 

Bring up the machines and set their host name as `web01`, `web02`, and  `web03` respectively, check `change hostname.md`

Get the IP addresses of the machines, we are going to add names to IP mapping in the scriptbox, so scriptbox can reference to all the machines using the name and not the IP addresses. But first we have to add all the IP addresses in the `/etc/hosts` file

```
$ vagrant ssh scriptbox

$ sudo -i

$ vim /etc/hosts

#CONTENT 
...

192.168.10.13 web01
192.168.10.14 web02
192.168.10.15 web03
```

Now you should be able to ping web01, web02 and web03.

```
$ ping web01

$ ping web02

$ ping web03
```

Login to web01 from scriptbox using `ssh username@hostname`

```
$ ssh vagrant@web01
```

NOTE the password for vagrant user is `vagrant`

```
$ hostname
```

So we will not use the vagrant user, we will create another user called `devops` in all the web servers. You don't have to do this for the `scriptbox` VM

Login to each machines and create the user `devops`. For Ubuntu machine, use the `adduser` command to create the `devops` user
```
$ ssh [USERNAME]@[HOSTNAME]   #OR

$ vagrant ssh [VM NAME]

$ sudo -i

$ useradd devops

$ password devops
```

So we will use the user to execute some system commands like installing packages, adding users etc. So we need to add this `devops` user into sudoers file. Check the lecture `33. sudo.md` to do this.

Do this for `web01`, `web02`, and `web03`

NOTE: When trying to login to web03 for ubuntu using `ssh vagrant@web03` you will get a permission denied error

```
$ ssh vagrant@web03

#OUTPUT
...

Permission denied (publickey).
```

The reason for this is because we can't login with a password only with the key. Whenever we tried login to web01 and web02, it asked us for password.

So web03 for ubuntu do not allow password for login. So we have to logout from scriptbox VM and login using `vagrant shh web03`. This is key-based login

```
$ vagrant shh web03
```

### HOW TO ENABLE REMOTE LOGIN IN LINUX MACHINE

To any linux machine, you're trying to login with password and it throws you that error `Permission denied (publickey).`. Most time, it's because the password login is disabled.

```
$ sudo -i

$ vim /etc/ssh/sshd_config
```

Find the lines below and enable them, by removing the `#`

```
    #before
#PasswordAuthentication yes

---------------------------------------------------

    #now
PasswordAuthentication yes
```

Restart the `sshd` service
```
$ systemctl restart sshd
```

Now login back to `scripbox` VM. and try login with password again

```
$ ssh vagrant@web03
```

If this works then go ahead and create the user `devops`, else scroll down and follow the steps to login using ssh key.

### CREATE USER `devops`

Now you can add the `devops` user in `web03`

Since this is an Ubuntu machine, we will use the `adduser` command.

```
$ adduser DevOps
```

We also have to add user `devops` to the sudoers file, but first we have to make vim the default editor.

```
$ export EDITOR=vim 

$ visudo
```

Check the lecture `sudo.md` on how to add user.


Now we are all set to do remote execution, we can now execute commands over ssh. Logout and login to `scriptbox` VM 

So this is how it works, we are no longer using the `vagrant` user, we are using the `devops` user we created.

```
$ ssh devops@web01 uptime
```

What happens is it will login to `web01` using the password, execute the `uptime` command, but we're still in the `scriptbox` shell. So we really don't need to login, execute command and then log back out. We can execute command from `scriptbox` itself.

### LOGIN TO UBUNTU USING SSH KEY

Sometimes, even after enabling `PasswordAuthentication` the machine would still try login using key. In that case we will generate ssh key to login with.

```
$ ssh-keygen
```

So it's key pair and it stores the key at `~/username/.ssh/`

`~/username/.ssh/id_rsa`: private key

`~/username/.ssh/id_rsa.pub`: public key

Copy the key in `~/username/.ssh/id_rsa.pub`, then go back to the ubuntu machine, and paste it in this file

```
$ vim /home/vagrant/.ssh/authorized_keys
```

After that you need to enable `PubkeyAuthentication` and `AuthorizedKeysFile      .ssh/authorized_keys` and disable `PasswordAuthentication yes`

```
$ vim /etc/ssh/sshd_config
```

Find the lines below and enable or disable them by adding or removing the `#`.

```
    #before
PasswordAuthentication yes
...
#PubkeyAuthentication
...
#AuthorizedKeysFile      .ssh/authorized_keys

---------------------------------------------------

    #now
#PasswordAuthentication yes
...
PubkeyAuthentication
...
AuthorizedKeysFile      .ssh/authorized_keys
```

Go back to `scripbox` and try login to `web03` again using `ssh`. Once you're logged in, go ahead ad create the `devops` user.
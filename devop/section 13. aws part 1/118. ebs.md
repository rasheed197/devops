# EBS

Welcome to the Elastic Block Store session.

`EBS`, as we call it, generally are really the virtual hard disks for your EC2 instance.

EBS basically provides you two things.

1. `EBS volume`: the virtual hard disk, 
2. `Snapshot`: which will be the backup of EBS volume.

So these virtual hard disks we generally call them as `EBS volumes`. 

## EBS VOLUMES
- It's a block based storage like an hard disk.

- Runs ec2 os, store data from db, file data etc.

    It is used to run your EC2 instance operating system. Like when you were launching the instance, we see in the storage 8GB of volume, that's the EC2 EBS volume, `Root volume` we call it, which stores your operating system data.

    It can also be used to store your other data like database, web servers, file data, which we'll be doing in this exercises.

- Placed in specific AZ. Automatically replicated within the AZ to protect from failure.

    While you are creating an EBS volume, you specify an availability zone, and your instance also should be in the same zone where you have the EBS volume.

    EBS volume data is automatically replicated within the availability zone, and this is so you can protect from any upcoming failure on your EBS volume at the data center level. But this is within the same availability zone, not in multiple availability zone.

## SNAPSHOT

- Snapshot is used to take the backup of the entire volume.

## EBS  TYPES

There are different types of hard disks, so there are different types of EBS volumes also.

- General Purpose (SSD)
    - Most work loads

    General purpose and as the name says general purpose. It is used generally for most of your workload. Like you want to run a web service, you will go for a volume type of general purpose.

    So this volume is SSD `Solid State Drives`.

- Provisioned IOPs
    - Large databases

    This is used to run large databases where you need really good performance for your database. So the IO speed will be more than the general purpose volume. A higher input output per second.

- Throughput Optimized HDD

    Used mostly for big data and data warehouses.

- Cold HDD
    - File servers

    It is generally used for file servers and it's really very low cost. 

    General purpose is the most recommended one from AWS, if you are running a general workload, you don't have a specific large databases or big data. So general purpose is the best combination of right pricing and right speed. But then based on the speed or the cost, you can select any other volume type.

- Magnetic
    - Backups and archives

    It is the slowest one and generally recommended for backups and archives. It's also very, very cheap.

You can check the AWS documentation to see more detail about these volume types. If you do a simple Google `EBS volume types`, you should come into this documentation.

So for this exercise we will need CentOS or Amazon Linux. We are going to go with Amazon Linux 2023, and we are going to provision it with the script.

```
#!/bin/bash
yum install httpd wget unzip -y
systemctl start httpd
systemctl enable httpd
cd /tmp
wget https://www.tooplate.com/zip-templates/2119_gymso_fitness.zip
unzip -o 2119_gymso_fitness.zip
cp -r 2119_gymso_fitness/* /var/www/html/
systemctl restart httpd
```

It's going to simply set up the website from `tooplate.com`.

So let's launch the instance, click `Launch instance`,

`Name`: `web01` 

`AMI`: `Amazon Linux 2023` 

`Instance type`: `t2.micro` 

We'll use the same `Key pair` and `Security group` we created before.

In `Advanced details` paste the script in `User data`

Now let's come back to `Configure storage`, you see by default it has 8GB.

Now it depends on the AMI that we are selecting, for `Amazon Linux 2023 AMI`, it gives 8GB of default volume, the volume type is `gp3`, you can wish to change this while we are launching it, or you can `Add new volumes`.

Also, we're going to see all that once we launch the instance, we're going to go through some steps to have the proper clarity on this EBS concept.

So keep everything default, make sure keep the script in `Advanced details` and click `Launch instance`.

So my instance is up and running, I'm going to SSH and check the server status. So copy the public IP, open your git bash or terminal.

```
$ ssh -i /Downloads/Moso-dev-nvir.pem ecw-user@[PUBLIC IP]
```

Okay I'm in. Let me switch to root user and first check the service status.

```
$ sudo -i

$ systemctl status httpd
```

The service is active and running, press `Q` to quit this, and let's check the files 

```
$ ls var/ww/html
```

So these are our website files right. And in this you have `images` folder.

So let's do

```
$ ls var/ww/html/images
```

Let's check the website from the browser, copy the public IP and put it in the browser. So these images that you see on this website are coming from that images folder.

And where are these images stored right now? Yeah, it's in that folder, but in which partition?

So any computer will have a hard disk. The hard disk of EC2 instance are the `EBS volumes`. So if you run this Linux command 

```
$ fdisk -l 
```

this is going to list all the available or connected hard disks. The hard disk is `/dev/xvda`.

It's 8GB in size and it has few partitions, the `/dev/xvda1`, `/dev/xvda127` etc.

The partitions are always connected to a folder or a directory. Then only you can access it. You cannot just do `cd` to this partition.

If you run this command 

```
$ df -h
```

you should see this partition `/dev/xvda1`, this is connected to or mounted to `/`. That's the root directory, and there's no other separate partition to store except this `boot/efi`.

So except this `boot/efi`, all the data in this machine is stored in this partition `/dev/xvda1`, because everything goes in root directory.

Now if you want to have a separate partition for any particular directory, we need to have another hard disk or any separate partition we need to create, and then we can mount it. That's what we will be doing in this lecture.

Let's go back to EC2 console, select your instance, then click on storage we should see here a disk path `/dev/xvda1`, scroll down to the `Volume ID`, if you click on it, it is going to take us to the `Volumes` section.

So there is a name to the volume. If you do not see the name to your volume you know this is the volume coming from your instance. You can check the instance ID `Attached resource`.

Make sure you give it a proper name, so we're going to name it as `web01-ROOT-Volume`, let's save it.

So now we have a requirement of adding extra storage for our images folder.

Let's take a look at the requirement first and then we'll do this EBS lab.

So coming back to requirement gathering storage size.

## REQUIREMENT GATHERING

- Storage size

    If there is a requirement we need 5GB for the web server images, because more than 30GB in EBS goes out of free tier. So overall you should have 30GB and less to be in the free tier of EBS.

    So 5GB for web server images, we have hosted a web service and that has some images and I want to keep those images into a separate storage, and that storage size should be 5GB. That's the requirement.

Okay. So come to volume section we have the root volume over here. We are going to create one extra volume. So click on `Create volume`.

`Volume type`, we're going to keep it as `gp3`. That's the general general purpose latest one.

Also you should see some other storage type as we discussed, `provisioned IOPS`, `cold HDD`, `Throughput optimized` and `Magnetic`.

We're going to go with general purpose. That's our requirement.

`Size`, keep it as `5GB` for now and scroll down, we need to select the `Availability zone`.

So availability zone depends on your instance. If your instance is in `1a` you need to create the volume in `1a`, otherwise you will you will not be able to attach the volume.

So we need to first check where our instance belongs to. So, go to `Instances` in a new tab and check your which zone your instance belongs.

So let's go back to `Volumes`, we need to create the volume in the same zone. Please do check where your instance belongs.

You can also encrypt the volume `Encrypt this volume`. This is called as `Encryption at rest`. So all the data that is stored in your volume will be encrypted. And to encrypt you need an encryption key.

So you have a default encryption key, you can select that, orr you can create a new key with `KMS` service.

I'm just showing you that this option exists. If you have a requirement then you can do this. But we are not going to do that for this lab.

But do remember you can encrypt in EBS volume, you can use the default key, or you can create a KMS key and then select that if you're going to try that.

Keep in mind `KMS keys` are not free. The default keys are free, but KMS keys are not free.

Okay, make sure to tag the volumes. I'm going to give it a name, `Name: moso-web01-dev-images`.

So again the name should be meaningful, this shows that this volume belongs for the `moso` project for `web01` instance, `dev` environment and it's for `images` folder.

Now let's create the volume, click `Create volume`.

Okay the volume is created, we don't see it, we need to refresh this. Then we can see the volume.

If you check this `Volume state` you should see it says `Available`. That means it's not in use, meaning it's connected to any instance, and you can see where it is attached to `Attaached resources`.

Now let's select our volume click `Action -> Attach volume`. You see it shows the `Availability zone`, it's going to show all the instance that is in this zone, select it and you should see your instance if it's in the same zone.

`Device name`, click on the drop down and I'm going to select as `/dev/sdf`.

Now the device name really does not matter because when you attach this volume it's going to change the volume name from `/dev/sdf` to to something like this `/dev/xvdf`. Let's attach the volume, click `Attach volume`, and let's refresh it.

Now let's go back to our instance, ssh into your instance.

So now if you do 

```
$ fdisk -l 
```

you should see the extra volume the extra hard disk connected, that's 5GB in size. 

Now we need to create partition from this. So we can use the `fdisk` tool in Linux.

So you can say 

```
fdisk /dev/svdf
```

Make sure you select the one you just created and not the root partition. Hit `Enter`.

Now there are many things you can do with this disk. With fdisk utility you can use `m` for help. So you see all the available options.

There are many things that you can do. You can `delete a partition`, you can `list the known partition`, you can `print the partition` and `add a new partition`.

So let's add a new partition

```
command (m for help): n
```

So it's asking, is this a primary partition or extended partition? Remember first four partitions are primary, and even if you hit enter it's going to select this, or you can just type `p` for primary partition 

```
Select (default p): p
```

The partition number 1 through 4, which one do you want to give. So I'm going to say `1` anyways that is default.

```
Partition number (1-4, default 1): 1
```

Now about the size. Now it shows you `First sector`. You have to select first sector, and then you need to select the last sector that will decide what will be the size. That's too complicated I understand that.

So just hit enter here which will select the first free sector.

```
First sector (2048-10485759, default 2048): 
```

Now you need to select the last sector, you can either give the size like plus `+3G`, that means 3GB of partition. So of your 5GB of volume, +3G means 3GB of partition will be created, 2GB will be free.

Or if you just hit enter, it is going to select the last free sector that will create the partition of the entire disk.

```
Last sector (2048-10485759, default 10485759): 
```

Use `p` to print.

```
command (m for help): p
```

You should see your partition `/dev/xvdf1`. That's the first partition and the only partition.

If you're good with this information, you can use `w` to write the changes.

```
command (m for help): w
```

Now if you do 

```
$ fdisk  -l
```
you should see your partition created.

So the partition is created but it is a raw volume. It does not have any format. The different types of format we have `NTFS`, `Fat`, `Extension`, `XFS`. 

Linux extension format, and XFS are most popularly used, in Windows we see `NTFS`, or `Fat`.

You know, in pen drives, USB drives, they are generally `Fat` partition. So you can use this command 

```
$ mkfs [TAB] * 2
```

Just hit <kbd>tab</kbd> two times quickly and you should see all the available commands with the format names.

So you have `ext2`, you have `ext4`, you have `vfat`, `xfs`, `msdos`, also you have `fat` partition.

So we are going to go with extension four `ext4`.

Root volume is with `xfs`. `xfs` is used for large volumes faster IO and `ext4` is just like general general purpose.

So you say `mkfs.ext4` and you give the path of the partition, and is going to format it.

```
$ mkfs.ext4 /dev/xvdf1 
```

And now you can mount it. Swe want to mount it on `/var/www/html/images`. We've already got data in that you know, if we mount it it will get mounted, but this data will now be in the root partition, it will be kind of hidden, you will not be able to see the data. The data will exist, when you unmount you should be able to see the data. 

So it's better we move this to some other folder. So I'm going to create a `tmp` folder.

```
$ mkdir /tmp/img-backup
```

And I'm going to move all the images to this temporary folder, so I can copy it back later when we mount it.

```
$ mv /var/www/html/images/* /tmp/img-backup/
```

So now this `/www/html/images/` will be empty.

Now let's mount it, this is a temporary mount that I'm showing you right now.

```
$ mount [partition path] [directory where you want to mount]

$ mount /dev/xvdf1 /var/www/html/images/
```

And now if you run the command 

```
$ df -h 
```

you should see this directory `/var/www/html/images/` is mounted on this partition `/dev/xvdf1`.

That means whatever data you put it on this directory will go into this partition `/dev/xvdf1`.

You can see its complete size, its available size. 

Now if you refresh your website, you will not be able to see the images because there are no image in the images folder. So let's copy back our images which is in `tmp`.

I'm going to move all the images to var/www/html/images folder, and I'm going to restart the `httpd` service.

```
$ mv /tmp/img-backup/* /var/www/html/images/

$ systemctl restart httpd
```
Now if you refresh the website, you should see all the images back.

Now this is a temporary mount, if I reboot this computer this VM this mount point will be detached. So I'm going to show you how to do a permanent mount. First let's unmount it.

```
$ unmount /var/www/html/images/
```

Now, you will not be able to see the mount point.

```
$ df -h
```

So I'm going to show you the permanent mount you need to do.

```
$ vi /etc/fstab
```

Open this file in `vi` editor, there are few entries in this file. So on a new line add the partition path followed by a space or tab and then the directory where you want to mount and few other options.

```
/dev/xvdf1    /var/www/html/images/    ext4    defaults    0 0  
```


At the top of the file you see a `UUID`, that is the uuid of the root partition. So instead of giving the partition name `/dev/xvdf1`, you can also give the partition uuid, then the folder where it is mounted `/var/www/html/images/`, and then the type. So we have formatted it with `ext4`. Then we  say `defaults`, we're not adding any special options. And  then `0 0` the first `0` is for `fsck` and second is for `dump`. So we're saying don't do any file system check or don't take any dump when things crashes.

Okay.

So we're taking all defaults option.

Now save and quit `:wq`.

So now do 

```
$ df -h
```

There is nothing mounted. But when you run the command 

```
$ mount -a 
```

this command is going to read the `fstab` file and execute the entries.

Now if you do 

```
$ df -h
``` 

you should see it mounted. 

Now while running `mount -a` command, if you get any error, check the entries whether the partition or directory path is correct or not. Check the options, spellings, or any typographical error, if everything is good, it should get mounted.

Okay, so one last time, restart the httpd service and join me in the next lecture where we're going to see more on the volume side.
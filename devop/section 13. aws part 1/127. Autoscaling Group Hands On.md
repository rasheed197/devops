# AUTOSCALING GROUP HANDS ON

Hello and welcome to the Auto Scaling Group exercise.

There are a few ingredients that we need before we get started. Auto scaling Group is going to manage AWS instances for us, group of instances. 

And if you want those instances under load balancer you need to have a load balancer. 

And if you're using application load balancer we also need target group. So we need a target group, we need a load balancer, application load balancer.

And for auto scaling group to decide what settings for the instance should be, like the security group, the key pair, it also needs for that launch template.

So we need launch template, target group and load balancer before we start auto scaling group.

So already have launch template that is for the previous inner peace instance. Then we created an AMI with the EFS. It's not mandatory to use the EFS AMI for this exercise, you can use the previous AMI also. But I'm going to use the EFS AMI because I want to make one point later.

So for that purpose, I'm using the inner peace EMI, which is connected to the EFS.

I need a launch template for this one, so I'm going to create a new launch template `Create launch template`.

I will name it as `InnerPeaceShared` because sharing your peace with others. It will just have the EFS AMI, that's all, otherwise everything will be same.

So let me select `My AMI`, so that's  `InnerPeaceEFS` `Instance type: t2.micro`. `Key pair`, same `InnerPeaceKey`. `Security group`,  `InnerPeaceSecurity`. You should have other security group also the one for load balancer, one for EFS, make sure you select the right one.

Resource tags, I'll just give `Name` as `InnerPeaceWeb` and you should tag the `Volume` and `Network interface` then click  `Create launch template`.

Okay, launch template is ready, let's go to the `Target group`. So we are not adding any instance in the target group. Auto scaling group is going to fill this target group with instances. We just need to create the target group, click `Create target group`.

`Choose target type` will be `Instances`, `Target group name` I will name it as `InnerPeaceASG-TG`, which represents that this is the target group for this auto scaling group that we are creating. Port 80 remains the default that we are using 

Health check also default, `Healthy threshold`, let's reduce the health threshold to two, so the instance becomes healthy quickly in just two health check, and we get the health instance and click `Next`.

You don't need to add any instance I don't have any instance. Even if you have instance do not add it. Just go click `Create target group`.

So we also need our instance to be under the load balancer. Now this is not mandatory.
L Auto scaling group does not mean you should have load balancer. Usually if you're serving a web traffic, you will have load balancer. But there are use cases where the instances should do some share working internal syncing internal communication, they don't need load any balancer, in such case you don't need to create any load balancer. My point is, it is not mandatory for auto scaling group to have load balancer, it's only based on your requirement.

Our requirement is web server traffic from the internet. So we definitely need an application load balancer. So let's create one, click `Create load balancer`, `Application load balancer`, click `Create`.

`Load balancer name` will be `InnerPeace-ASG-Alb` represents that, this is the load balancer for the auto scaling group. Let's scroll down. Let's select all these zones, that means the instance can be in any of the zones. And the load balancer is going to serve the traffic to those instances distributed in these zones.

Remove the default `Security group` and add the load balancer security group. Listen on port 80. That's the listener. And forward the traffic to the `Target group`. That's the target group that we created which does not have any instance now, but once auto scaling group adds the instance in this target group then it will be good.

And that is it, let's just `Create load balancer`.

So wait for a few minutes until this load balancer gets in `Active` state, ut's still provisioning.

Now let's go to the `Auto Scaling Groups` and say `Create Auto Scaling group`.

Let's give Auto Scaling Group a name, simply name it as `InnerPeace-ASG` and select the `Launch template`. Now previously AWS had a launch configuration also, which is similar to launch template, but now it supports only launch template.

So anyways we just have option to launch template. We already have it, we created it. So based on this information, Auto Scaling group will decide everything, the security group, key pair, all the information that comes from the launch template. So click `Next`.

Now network we need to select the `VPC`. So we have just one default VPC will keep it as it is, Now you select in which zone you want Auto Scaling group to launch your instance. So I'm going to select all of them.

If you have some specific use case where you need to launch only in that particular zone, you can select only that zone or a group of zones. I've selected all the zones here.

Let's say it has like ten instances to launch, on which availability it should select, this is a new option, it has given `Balanced best effort`. If launches fail in one Availability Zone, Auto Scaling group will attempt to launch in another healthy Availability Zone, which is a good option. Sometimes the AZ gets overwhelmed, very rarely it happens, but anyways, you have that option.

The `Balance only` is going to launch it into the AZ, if it fails, it's going to keep attempting to launch it into the same AZ again.

So as I said, if you have that kind of use case where you need to select that AZ, only then you better go with `Balanced only`. Okay, let's click `Next`.

`Load balancing` option, do you want this instances to be under a load balancer or no. So our use case says yes. And we have already a load balancer.

So we're going to select `Attach to an existing load balancer`, it says load balancer, but basically it adds under the target group, so you need to select the target group.

If you're using a classic load balancer then yes you need to select the load balancer, but if you're using Application Load balancer or Network Load Balancer, you will get option to select the target group. As I told you previously, we create the target group empty, auto scaling group is going to add or remove instances from that target group, and this is where we select it Okay.

This option `Health checks`, this is quite interesting and very helpful. Very necessary in web applications. So what autoscaling does is it launches instance and this group of instances that it maintains if any instance is unhealthy, it is going to remove that instance and add a healthy instance or add a replacement basically.

So by default it has the EC2 health check to check the health of the instance. And EC2 health checks are pretty basic. This is just going to check the hardware on which it is running and the VM health. And if it is healthy it consider it as healthy, but the service running in that dies or gets overwhelmed if the process crashes.

Let's say Apache process crashes, but the instance EC2 health just shows healthy. So Auto Scaling group will not know in that case whether the process is crashed or not. But there is a way, it has given us the option to `Turn on Elastic Load Balancer health check`. We have seen this in the load balancer exercise. You can go back and revisit if you don't recall it.

The health check on the target group, we mentioned the port number 80, the protocol http, the health check path, that way we can check the protocol, the port number, if it's responding, then we consider it as healthy in load balancer. And that is a very good way of deciding whether the instance is healthy or not.

So let's take an example. So we have a group of web servers in the EC2 instances. And one EC2 instance web service crashes, the process dies. The health check in the target group will fail. Health check in the target group will declare it as unhealthy. The auto scaling group will know it. Auto scaling Group will launch a replacement and remove the unhealthy instance.

Now along with this, there's also one more health check `Amazon EBS Health Check`, which checks the root volume or any attached volumes. When these volumes are unhealthy, definitely the instance will be unhealthy, the process will be dead. You don't want such instance in the auto scaling group, so we can turn on this as well.

Now in this case, you might be wondering the instance is deleted. What happens to the data? If you are storing data in the instance, make sure it is stored into a shared storage or into any file storage out of the instance, not on the hard disk, not on the EBS volume. You need to design your application to use a shared storage or a file storage somewhere out. So if the instance gets deleted, your data is intact. Otherwise, there is no point of using auto scaling group because ASG will delete unhealthy instance or will remove it from the group.

There is another option I will show you later to preserve that instance. But in any case you are using auto scaling group. You need to have shared storage or file storage. Store your dynamic data out of your instance.

Okay, then let's click  `Next`.

Okay, so first let's decide the `Desired capacity`, how many you want. So let's say I want 2 instances. I'm just throwing a random number at this.m, it totally depends on your project requirement your business use case. So I'm just keeping it as two. 

`Scaling limit`,  Now we will be using scaling policies for CPU utilization. If the CPU is below a certain point or above a certain point, ASG can decide whether to delete or keep the instances or the number of instances how much it should have. So we are saying that minimum it should have one `Min desires capacity`. In any case, even if there is no load, there's nothing, atleast I should have 1 or 2 based on your requirement. I'm just keeping it one. 

`Max desired capacity`, if the load goes high, then maximum how many instances you want. So I'm saying I want maximum four instances and will enable `Target tracking scaling policy`.

So here in `Metric type' we have option of `CPU utilization`. We have network in, network out. This is also very useful in web traffic, where more traffic are coming in you add more instances, when traffic is reducing you remove instances. But let's keep `CPU utilization` for now.

`Target value` 50.So combined group of the CPU utilization. If it's above 50 then it is going to add instances, how many maximum it can go four. If it's below 50 it can remove instances, minimum it can have one.That again depends, I'm just throwing some random numbers over here. We also have an option to `Disable scale in in this scale out policy`. Let's say you don't want your instance to get deleted, if the CPU utilization or any of your metric that you selected, if it's, you know, less than the target value, you don't want your instance to get deleted. By default, auto scaling group will delete. If you don't want, you can  check mark this `Disable scaling to create only a scale out policy`.

Okay. `Instance maintenance policy`. This is a new one. How do you want to delete or add instances? Do you want to delete first, add later or add first delete later or do both at a time. You have options for that.

So `Launch before terminating`. That's a good one. It launches the instance and wait for them to be ready before terminating the unhealthy instances. Right, this is good, but this adds cost because the instance needs to be ready, then only it is going to delete the old one.

This controls cost the `Terminate and launch'. At the same time, you can have `Custom behavior` also. 

We are just keeping it `No policy`. So in this, instance will launch before terminating the unhealthy one, but it's not going to wait for it to be healthy.

Okay.

In `Additional settings` we have `Instance scale-in protection`, and this is for newly launched instance. So if you enable this, then by default the newly launched instance will not be deleted.

If you want, you can enable it `Monitoring`, you can have the metrics for this collected together in the CloudWatch, which will be really helpful later. Not enabling this. This might add some cost.

Okay let's click `Next`.

Notification, you can `Add notification` for these events, Launch, Terminate, Fail to launch, Fail to terminate, and you can select your topic e.g InnerPeaceNotification. In this case, you'll get notification if the instance is launched or terminated, or if there is any failure in launching and terminating.

Let's click `Next`.

Tags, let's add `Name` tag `InnerPeaceWebESG`, just so we can see when the instance gets launched it will have the name tag.  Let's go `Next`.

So review all the settings that you have selected. Once you are good with all this you can click `Create Auto Scaling group`.

Now as soon as you create Auto Scaling Group, it will start launching instances and put it under the target group. So I'm going to wait for a few minutes until all this becomes stable. And then I'm going to show you more settings in Auto Scaling Group.

Okay I was waiting for five minutes and now let's check. So if you scroll to the right, it says it has two `Instances` as per the two `Desired capacity`.

If we go to `Instances` we should see the two instances. Two running instances, they should be in the target group.

Let's go and check the `Target groups`. Okay, two total targets. Both are healthy. Very good. And now it should be under `Load balancer`.

Let's get the endpoint of the load balancer and check the website. The DNS endpoint, let's copy this and let's test it on our browser.Great. It's coming. And also the images, yes those are coming from EFS. Now I've used the EFS AMI and we know that we have stored these images in the EFS storage, so everything works together very well. Amazing.

Now let's look at a few settings of Auto Scaling Group that will be very helpful for you.

So starting with updating your application. So we have a website and developer writes code. They make changes and we need to deploy those changes. In the instances you cannot directly log into the instance and make changes. These are the group maintained by Auto Scaling group. So there is no manual changes, no logging into the instance and making the changes you need to make.

You need to build a new AMI with your changes, update your launch template or create a new launch template and make the changes in the auto scaling group. Okay, so you can change the launch template.

You can click `Edit` on the `Details` so you can select the different `Version` of your launch template or you can change the `Launch template` itself. But when you do this you need to apply these changes. So I'm saying `Update launch template`. I'm updating with the previous template that I have, that is without EFS.

Usually it will be the different version, the other version of the launch template. But I'm just changing the template itself, which you can do. And if you want to make other changes like you want to change the `Instance type` and all, you can `override those changes as well from launch template `Override launch template`. And I'm going to say `Update`.

So now if let's say a new scaling event comes in, you know the load is going up it is going to launch new instance. The new instance will be from the new launch template that you have updated. But existing instance will be there as it is. So in order to do the complete refresh, you need to go to the `Instance refresh` and you need to say `Start instance refresh`.

You can select how do you want the replacement, terminate and launch at the same time, or you want to launch the instance, wait and then terminate the old instance. I'm just keeping it as `Control cost`, terminate and launch at the same time. There are few other options in this, let's just go and simply `Start instance refresh`.

Okay, you can look at the `Instance refresh history`, or you can also look at the events in the `Auto Scaling group`.

In the `Activity history` of the auto scaling group, you can see the previous events that happened. You see it says launching a new instance terminating the instance. So both it did at the same time okay. By the time this is happening let's take a look at `Instance management`.

So you can select an instance (not the terminating instance) and you can perform some `Action`. So you can `Detach` an instance from the auto scaling group.

You can set it on `Standby`. When you do it on standby. It doesn't take activity in any scale-in or scale-out event.

You can set a `scale-in protection` to a particular instance. Let's say you are troubleshooting, you don't want the instance to get deleted. Maybe you're doing something, looking for something, some information.

So that might trigger a scale-in event if the process goes down. So while you're doing that, you can set a scale-inprotection so you can safely log into the instance, make the changes. The instance won't get deleted.

And there is `Automatic scaling`. So we are using a scaling policy. `Target tracking policy`. You can create your own policy also, you can decide how many instances should be added if the load is so and so I'll just show you this quickly, click `Create dynamic scaling policy`.

So here I'm going to say `Policy type` is `Step scaling`. I'll give it a name `Scaling policy name` as `ScaleUp`. Now for this one you need to have a `CloudWatch alarm`. So you need to create a CloudWatch alarm. I have one sample one, so I'm just keeping it. This is not for this instance just a sample one.

So under `Take the action` I'm saying `Add` 1 instance, if the capacity is 50, I can add more step `Add step`, I can say if the `CPUUtilization` is 60. If it's above 50, it launches one instance. But if it goes above 60, launch two instances.

Now these numbers are totally random, if you are going to do this, you need to decide this based on the performance testing. There should be a testing team who makes the performance testing on your application. You need to have proper information that your instance works till how much and crashes when, based on that you can decide these things.

You can set up scale-in policy, scale-out policy both adding and removing this option. Also to remove you can have multiple policies in the auto scaling group. 

Just showing this option, so you would know such kind of thing exists in auto scaling group click `Cancel`.

These are very interesting options. So you're not setting any other policy. But we have here one new thing `Create predictive scaling policy`. Now, this totally depends on the historical data, what happened previously, if you enable this, based on that, it can scale-out in advance. Really out of the scope for this course. It totally depends on the historical data. Once again, you should know such thing exists in Auto Scaling group. Yes, you can play with it later.

Then in the same `Automatic scaling` tab, you have `Create scheduled action`. This is useful. You can create a schedule action at a particular time. Let's say you know there's a sale coming in on a website. And you know there are many users who are going to access the site. So you can decide at what particular time it starts. And you can also set the end time as well. So I'll say `Desired capacity` should be 10, `Min` should be 5 and `Max` should be maybe 12.

And `Recurrence`, do you want it once or do you want it like every week? If you're selecting every week or every day, you also get an option for the end time `Set end time` when you want to end this scaling.

So it's also one more very interesting option in auto scaling group. So take your time and go through different settings. Take a look, don't be in a rush. We have free tier instances so no need to worry. Just make sure after some time you delete the load balancer. Even if you don't delete the auto scaling group, we can just reduce the capacity, min and max to 0, 0, and 0, and it is going to delete all the instances.

You can have auto scaling group without any instances that also you can have no cost. But the only problem with this will be you have a load balancer. You cannot keep this load balancer for a long time, otherwise you'll get some cost.

So this was quite a long lecture, but it really binds everything together that we have learned so far. You have instances here, Key pair, security groups, load balancer, target groups, AMI, Launch template, everything. All of the things that we have learned previously, it binds everything together, including the CloudWatch alarm and the EFS storage.

Once again, make sure you have a shared file storage if you're using Auto Scaling Group and it is storing the data. If the data is dynamic, the data should be not living in the instance and this is called as stateless application. The application that doesn't store any data locally. If it stores the data, the application is stateful, but you can store it outside and your instance becomes stateless.

You know, even if you remove the instance, add it, delete, it doesn't matter. In this case, you're using instance only for its resource capacity, CPU, memory, operating system, but not for the data that goes out.

Okay, once you're done playing with this, start deleting the load balancer. First, let's do the cleanup `Action -> Delete load balancer` confirm delete.

You cannot just directly delete the instance in an auto scaling group even if you delete it, auto scaling group will create it again, because you have mentioned the desired capacity, it will always keep that capacity. So if you want to delete the instance, either you empty the auto scaling group, you set the desired capacity minimum capacity to zero. It will delete the instance, or you delete the auto scaling group itself.

So for now, as a part of a cleanup, I am deleting auto scaling group. You don't need to do this. You can keep it. You can just reduce the capacity to zero.

Remove target group also, again part of a cleanup not required, not mandatory, no cost here.

Also finally AMIS, I'm just going to keep one AMI which is connected to EFS. The other one I'm going to remove `Action -> Deregister AMI`. The option is deregister Ami, there is no delete option. Forced to deregister the Ami.

Then you go to the snapshot. You check which snapshot is for your AMI. There are two snapshot over here. I should have named the snapshot. This is the problem if you don't name stuff properly. Try to delete both, it is not going to let me delete the one that is connected to the AMI. I guess it failed to delete the snapshot that is connected to the AMI, the one that we deregistered is gone.

So that one AMI, I'm keeping, that is with EFS, that we can use later also. Everything else you can delete, just make sure at the end go to the `Dashboard`, refresh and see you don't have anything extra, if you have you can delete them. I have one snapshot, one volume.

I think the instance is still getting deleted. Okay, I have a running instance from the Auto scaling group, I'm going to terminate this one also, that will anyways get terminated with Auto Scaling group. I'm just giving it extra help. I have done proper cleanup. You also make sure you do proper cleanup. Just have one AMI.

And now with that note, I'm closing this lecture. Thank you very much for watching. I will see you in the next one.

 
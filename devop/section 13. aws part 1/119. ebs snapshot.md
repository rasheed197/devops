# EBS SNAPSHOT

This is the continuation of previous EBS lecture. In this lecture, we are going to talk about `Snapshots`.

Snapshots are a backup of EBS volumes. 

So we're going to do a lab. We're going to conduct some exercise through which we are going to understand the benefits of snapshot, how to use it, when to use it, and what are other features of snapshots.

So make sure you have that `web01` instance. If it's not there, create it once again.

If you're following from the previous lecture, then first, we are going to detach the existing volume. So `ssh` to your instance and check 

```
$ df -h
```

You should see it is still mounted. Before unmounting, let me show you one more thing.So first, I'm going to do `cd` into this directory `/var/www/html/images/`,

```
$ cd /var/www/html/images/
```

If you want to check what directory is used

by which process, there is a command called `lsof`.

You can say `lsof` and you can give the path of a directory to see if there are any processes using it.

```
$ lsof /var/www/html/images/
```

So you see it says `cwd`, that means somebody's cd into that directory or folder, and that's the processes ID.

Now cd out of the directory and do `lsof` again to see if there is any other process that is connected to i

```
$ cd

$ lsof /var/www/html/images/
```

You should not see anything. But if you see any process, you can kill that process to free that directory. Then only you can unmount it, because if I try to unmount it when there's still a process using it, it should give me an error `Target is busy`.

So you can either close the process, like in this case I can just do `cd` out of this folder and I can then unmount it, it will work.

```
$ unmount /var/www/html/images/
```

We also have the entry in the `fstab` file. So let's remove that entry from the fstab file.

So open fstab file 

```
$ vim /etc/fstab
```

at the last line, go to the last line and do <kbd>dd</kbd> to remove the last line. Remove only the last line. Don't remove anything else. Save and quit <kbd>:wq</kbd>.

Now let's detach this volume, `moso-web01-dev-images`, click `Action -> Detach volume`.

Now, if the volume is busy, you will not be able to detach it. You might also need to do `Force detach volume`, but we have freed the volume so it should be detached.

Refresh and check the volume `Volume state`, it should say `Available`. Now you can delete this volume click `Action -> Delete volume`.

Okay, now we will see one more use case where we are going to run MySQL service, MariaDB service, and its data will be stored into a separate volume. And when you want to do such kind of thing, you need to create the volume first, partition it, create the directory, and then install the service.

So when the service starts, it automatically starts storing the data on the separate partition.

So follow this exercise. First of all, `Create volume`, type `gp3`, we'll keep it as `5GB`. My instance is in `1c`, check which zone your instance is and select that zone. Tag it, we'll call it `Name` `db01-mysql-vol`. Click `Create volume`.

Now select that volume, click `Action -> Attach volume`.

Select your `Instance`, and `Device name` e.g `/dev/sdh`, click `Attach volume`.

Let's go back to our instance and rename it as `db01`.

SSH to the instance, and let's run 

```
$ fdisk -l
```

We should see a new volume here. The old one is detached. It's gone. So you'll not be able to see that.

Now, same thing, we'll create the partition.

```
$ fdisk [partition path]

$ fdisk /dev/xvdh
```

`n` to create new partition, `p` for primary, partition number `1`, first sector, just hit <kbd>Enter</kbd>, last sector, hit kbd>Enter</kbd>, `w` to write.

Let's run 

```
$ fdisk -l
```

The partition is created. Let's format it. This time, let's do it with `xfs`.

```
$ mkfs.xfs /dev/xvdh
```

Okay, now we are going to create a directory,

```
$ mkdir /var/lib/mysql
```

Now, I know when I install the, MariaDB service, when I run it, it creates a folder `/var/lib/mysql`, and stores the data on that. I'm creating that folder beforehand and I'm going to mount it.

```
$ mount /dev/xvdh /var/lib/mysql
```

I'm just doing a temporary mount right now. Later we can do the permanent mount.

Let's do 

```
$ df - h
```

and we should see it is mounted. Okay, so the partition is ready, the folder is ready, it's mounted. Now it's time to install the MariaDB service.

So the package name is mariadb105-server. So to install it do 

```
$ dnf install mariadb105-server -y
```

before starting the service, if we do

```
$ ls /var/lib/mysql
```

You should see nothing over here.But when we start the service

```
$ systemctl start mariadb
```

And now let's do

```
$ ls /var/lib/mysql
```

You should see the data. Now, we know this folder is connected to the partition. It's mounted to the partition.

```
$ df -h
```

So this data `/var/lib/mysql` is going to go to this partition `/dev/xvdh`, right?

So DB data is getting stored in a separate partition. And what happens if data is lost or corrupted? You will say, "If I have backup, I can recover."

So EBS provides you an option `Snapshot`. Yoou can take snapshot of a volume. When you take the snapshot first time, it's going to copy all the data. Later, when you take more snapshots, it's going to copy the incremental data.

So if I select the DB volume, and click `Action -> Create snapshot`, it is going to create a snapshot of 5GB. Let's give some `Description` `db01-mysql-snapshot`. Let's give it a tag, `Name` `db01-mysql-snapshot`, and say `Create snapshot`.

Let's go to `Snapshots` section and you will see a snapshot. The `Snapshot status` is pending. We're going to wait until the snapshot is completely created.

Okay, so after a few minutes, the snapshot got completed successfully. So now let's try to remove the data, you know, corrupt the data. So I'm gonna simply remove /var/lib/mysql

```
$ rm -rf /var/lib/mysql/*
```

And let's try to restart the server,

```
$ systemctl restart mariadb
```

And you should get an error. And if you run the `journalctl -xeu ...' command, it's going to throw a lot of errors and tell you that there is some problem with the data missing.

So we have a snapshot, we can recover the data from the snapshot.

First, let's detach the volume.

```
$ umount /var/lib/mysql
```

If we do

```
$ df -h
```

It should not be there again. If it's giving you the error that it is connected somehow, run `lsof` command on the directory, find the process ID and kill it, `kill -9`, kill the processes and then unmount it.

So let's go to volumes and let's first of all, rename this volume to let's say `db01-mysql-vol-corrupted`, corrupted volume.

And now we are going to create a new volume from the snapshot that already have the actual data.

Go to `Snapshots`, select your snapshot, click `Action -> Create volume from snapshot`.

A few other options, we'll take a look at them in a moment.

So when you create a volume from a snapshot, you have some nice options, like you can change the `Volume type`.

Our requirement is to recover the data, but if you have a requirement to change the volume type, e.g from `General purpose` to `Provisioned IOPS`, in DB case, that is done. When you, huge I/O, then you can change from general purpose to provisioned IOPS.

And to do that, take a snapshot, create a new volume from the snapshot, but we're going to keep it as just `General purpose three`.

And you can change the volume `Size` also, increase it. Dif you deecrease it, there is a chance that, you know, you might lose the data, but anyways, you have snapshot, but increasing is always an option.

You can change the `IOPS`. You can also change the `Zone`. You can move a volume from one zone to other zone by taking the snapshot. If you want to move the volume and connect it to an instance that is in another zone, let's say it's in `1d`, `1f`, whatever, take the snapshot of the volume, create a new volume and select the zone where you want to move it.

But our requirement is we're going to keep it in 1c because my instance is in 1c.

Also, you can `Encrypt` an unencrypted volume through a snapshot.

Let's give a `Tag`, `Name: db01-mysql-vol-recovered`. I'm just giving it recovered so I can easily identify it. Click `Create volume`.

Let's go to volumes and let's refresh. So we have the recovered volume and we have the corrupted volume. We don't need the corrupted volume, so we'll just remove it.

First, we need to detach the volume `Action -> Detach volume`. It's detached, it's in available state. Now I'm going remove it `Action -> Delete volume`.

Okay, so if I do

```
$ fdisk -l
```

I should see only the root partitions. But now I'm going to connect the recovered volume, `Action -> Attach volume`, select my `Instance`, and give it `Device name` and click `Attach volume`.

Okay, now let's check it once again, 

```
$ fdisk -l
```

We see the volume, we see the partition in it, and it has all the data. If you mount it back

```
$ mount /dev/xvdf1 /var/lib/mysql
```


Let's run 

```
$ df -h
```

It is connected. Let's do 

```
$ ls 
```
and let's see if the data exists or not. And voila, the data is back.

Let's restart the service, 

```
$ systemctl restart mariadb
```

The service got restarted. Let's check its status, 

```
$ systemctl restart mariadb
```

The service is active and running, so everything is good, we are back in the game.

So you have seen benefits of snapshots. You can create a volume from the snapshot, and while creating the volume, you can change many parameters, like volume type, encryption level, but primarily, you need to take the snapshot of the volume.

You can keep taking the snapshot on regular interval. The first snapshot will be the full backup of the volume.

The latest snapshots that will come after that will be the incremental backup.

You see some more options. If you click on `Actions` in the snapshot,

you should see `Create volume from snapshot`. That's what we did.

You can `Create image from snapshot`, the AMI. We'll talk about the image creation later.

You can copy a snapshot. So if you click `Copy snapshot`, let's see what options you get. You can select the region, so if you want to copy data from one region to other region, you can do it through snapshot. So the snapshot will be copied to a different region, and then you can go to that region and create a volume from that snapshot.

So if someone asks you or if you have a requirement, how to move data, how to move the EBS data from one region to other region, it's through `Snapshot`. Take a snapshot and copy the snapshot to the target region, right? We are not gonna do that because it's not a free exercise, but it's super easy to do you know, you can just select `Action`, `Copy snapshot`, select the `Region`, and wait for some time. You go to that region, you should see the snapshot.

I want to show you one more option with this. If you go to `Actions -> `Snapshot settings` -> `Modify permissions`, you can make a snapshot `Public`, or you can share it with different AWS account using the `Add account`.

So if you want to copy data from one AWS account to other AWS account, you can use `Snapshots`, you can say `Add account`, you give the account ID, then click `Add`, and the snapshot should be appearing in the other AWS account, right?

So not just the backup and recovery, but many other thing you can do with snapshot.

So once you're done with this exercise, we're going to do the cleanup now.

So  delete snapshot `Action -> Delete snapshot`. That's one thing you need to do first, delete a snapshot.

Let's delete the `Instance`. So select your instance. `Instance state -> Terminate(delete) instance -> Terminate(delete)`.

So once you delete the instance, this will remove the root volume, but the volume that we have created, that will not be removed.

So you need to remove those volumes that are created by you. So select that volume

and say `Action -> Detach` then `Action -> Delete`


So you need to wait for a moment. Let's check the instances, once it's deleted, then only go and remove the volume.

Okay, let's go to `Dashboard` now, and let's refresh and check what we have?

We have 0 running instances, we have 1 key pair, 2 security groups. no volumes, no snapshot.

Make sure you have zero volumes, 0 snapshots.

So wrap this up quickly. We have many more things to learn in this AWS section.

The next section, we're going to start with the load balancers.

So clean up everything and join me in the next lecture.



# EFS

Hello and welcome.

In this lecture we are going to learn about EFS, Amazon `Elastic File System`.

So Amazon EFS is a shared file system. Before we learn this we need to understand what is a shared file system and why do we need it?

So let's say we have a website hosted on a group of servers with a frontend endpoint of a load balancer,, so users access the load balancer.

Let's say the users are uploading some images. This is a site where users upload and share images. So request goes to the load balancer, the load balancer routes it to one of the server, user uploads the image, and image gets stored into the hard disk of the server. The server could be EC2 instance, could be a virtual machine, could be a physical server, anything. Any computer like this will have its own hard disk where it stores the data.

The data consists of, first of all, the operating system, then the application, the services running and the data the service is storing or retrieving. So let's say images are stored on web01 server's hard disk.

Now what happens if the user accesses again the site and the load balancer routes the request to web02 server? So image was stored on web01 hard disk, and when the user later comes and it redirects to web02, web02, hard disk does not have that image. That's the problem right? So that is the problem with the block storage like EBS or any hard disk of a computer is called as a block storage.

So the files that needs sharing should be in a shared storage. The storage should be centralized for such kind of files.  Now in this case the servers will have their own block storage where the operating system and the service resides. But the shared files like for example, images, videos and documents that need sharing, those kinds of data should be going into a centralized storage, or we can call it as a shared storage.

In Linux, the most famous shared storage protocol is `NFS`. NFS is used as a shared storage. And to build NFS shared storage, we need to host NFS server, which contains all the hard disk and we need to manage this NFS server. EdSo an extra overhead to manage this shared storage, but it is required.

Now enter EFS Amazon Elastic File System. It is the shared storage hosted on the AWS cloud. So you can simply create it and attach it to your instance, basically, mount it on your Linux instance. And it's not only for the AWS EC2 instance you can use it from your data center also, you can store data on Amazon EFS as a shared storage.

So we'll do this exercise. First we need to spin a web server and then mount the shared storage on it. And we're going to do it for images of our website. EFS is a network service, and a network service on AWS needs a security group. So first we need to create a security group for the EFS. So let's go to the `EC2` service. Let's go to `Security groups`. Let's `Create security group`.

Let's name it as `innerPeace-EFS-SG`, same I'm giving in the `Description` 

`Inbound rule`, now the security group is for the EFS. The request is going to come from our web server our EC2 instance. So EFS works on NFS protocols. So in the `Type` we select `NFS`, the port number is `2049`. And the request should be allowed from the security group of our inner peace web server, the `Source` will be `Custom`, and then we select inner peace web server security group. So when we launch the instance we're going to keep it into the Inner peace security group. Some description `Allow NFS Access from Inner Peace webservers SG`.

So that's the only rule we need. Once again the security group is for the EFS. The request is going to come from or the access is going to come from this Inner peace web server security group. Click `Create security group`.

Now let's go to `EFS`. So you can just search for EFS and you should watch this video there. It's a very nice video explains to you about the benefits of EFS, how you can use it, what are the use cases? Really nice small video. Definitely watch this video.

And once you're done, come to `File systems`, let's create the EFS file system. Now like we create an EBS volume. It is almost similar to that but this is a shared storage. EBS volume can be connected to only one instance at a time, but EFS can be connected to multiple instances at a time. That's what shared storage is. So let's click on `Create file system`.

Let's give it a name. So EC2 instance when we launch has a folder `images`. If you have something else in the folder like `img` or something you can use that.

So most of the template that we download from tooplate.com, when we unzip it has a folder images or img. We'll see that when we launch the instance just give the name `innerPeace-images` or whateveryour project name is and click on `Customize`.

I'm going to show you many options over here. So `File system type`, we are keeping it as `Regional`. So in a region, which is North Virginia I'm using, it will be available for all the zones. But if you want only for one zone you can select `One zone` as well. That will save you some cost. But for now the access that we are doing is going to be free. So do not worry about that. So keep it `Regional`.

There is an option of taking automated backups `Enable automatd backups`. You can put a check mark or just remove it. We are not going to take any backups.

`Lifecycle management`, like after the backup is taken, what you want to do after 30 days you can transition into archive to save the cost.

So `Transition into Archive` select `None`. Transition into Standard` select `None`

`Encryption at rest`, So EFS stores all the data encrypted. That's called as `Encryption at rest`. `Encryption in transit` means when the data is traveling. So EFS stores the data encrypted if you checked this option. Otherwise you can uncheck it if you don't need it. In real time, most cases, this will be checked okay.

`Performance settings`, if you need high performing storage, throughput mode, you can put it as `Enhanced`. We're going to keep it as `Bursting`. Bursting is going to scale whenever it's required, otherwise it will be smaller. This saves cost, `Enhanced` is just faster.

You can check in the `Additional settings`. Here we have performance mode, `General purpose` or `Max I/O`, we will stick to `General purpose`.

`Max I/O` is used to tolerate higher latencies, but just keep it `General purpose`. 

`Tags`, let's give the `Name` tag `innerPeaceImages`, then click `Next`.

Okay, so for all the availability zones there are subnets. And on that there is a security group that decides what request can come in. So default security group is selected. Just remove all the default security group from all the subnets and then select the `EFS security group` that we have created for all the zones. And then click `Next`, `Next` and then click `Create`.

The file system is getting created. It's going to take few seconds to be in available state.

Now, how do we access this EFS storage? There are multiple ways of accessing an EFS storage. You can do it through IAM user also. But we are going to use access points. So you need to create an access points, and his access points will connect your instance to this EFS file system.

So go to `EFS -> Access Points` and say `Create access point`.

Select the `File system` and scroll down and click `Create access point` okay.

So the access point is also created. Now how do we connect this to our instance? We have a folder images folder, and we want to put all the data that it contains to this EFS file system. So let's launch the instance and let's take a look at that.

So go to `Launch templates`. You should have the launch template for Inner peace. Just simply launch the instance from there, `Action -> Launch instance from template`.

Only one instance we need for now, click `Launch instance`.Okay.

It's already in running state, so I'm going to take its public IP and do SSH to it.

```
$ ssh -i Downloads/innerPeaceKey.pem ec2-user@[ip address]
```

Switchto root user.

```
$ sudo -i
```

Okay.

So one way we mount a file system  is manually, the other way is through `fstab` automatically when the operating system boots it automatically mounts. We have seen that in EBS lecture.

But the point is this Linux operating system does not understand what is EFS or what is NFS. So we need to install some packages. Then only it will understand what is EFS. And then we can mention that information in fstab file to mount it.

So first let's go to `var/www/html`. That's where our website data is located. Here I have `images` folder. You might have images or img based on what template you're using. Let's check the website from the browser.

So first let me go to the `Security group` of this inner peace instance. `Edit inbound rule`. Okay so I have access port 80 allowed from the load balancer security group. I'm going to add here port 80 from my IP. `Save rule` take its public IP. And let's check it from the browser. You should see the images in the website, those are coming from this images folder.

I want you to move these images to a different location like create temporary folder temp images and move everything from the images to it.

```
$ mkdir /tmp/images

$ mv /var/www/html/images/* /tmp/images 
```

Restart httpd service

```
$ systemctl restart httpd
```

Okay so one more reason I have moved the images to temporary images folder is because we are going to use this folder `/var/www/html/images` as the mount point. This will be connected to the EFS file system. Then we put images in this. Then it goes to the EFS file system. Right now it's just living in the hard disk.

So in order to mount the EFS file system over here, we need to install some tools and set right information in fstab file.

Okay so I just searched on the internet `install EFS client or EFS utils on Amazon Linux 2023`. I'll put this link in the lecture resource also, or you can simply ask ChatGPT how to do this.

```
$ sudo yum install -y amazon-efs-utils
```

So that is on Amazon Linux 2023.

But you can install it through different packaging mechanism.

Also, like `apt` on other operating system, you just need to search for how to install Amazon EFS utils on the operating system name. You will get the package name and the steps to install it.

So mounting file system, In this documentation section you have `Existing EC2 Linux instance` and we are using `EFS access point`, not `IAM authorization`. So copy it and bring it into a notepad okay.

So first you need to give file system ID.

```
[efs file system id]:/ efs-mount-point efs _netdev,noresvport,tls, access point=access-point-id 0 0
```

So this information goes into the `/etc/fstab` file.

So here `[efs file system id]` we need to put the file system ID,  here `efs-mount-point` the mount point path which will be the images folder. `efs` is the storage type.

Let's copy all this information now, open fstab file

```
$ vim /etc/fstab
```

Go to the last line and paste it.

So once you do this save and quit, let's run 

```
$ df -h
```

Right. So there's no mount point yet. We're going to say 

```
$ mount -a
```

which will read the fstab file. Okay. Now let's run 

```
$ df -h
```

Okay. It's mounted. Now let's bring back our images. So I'm copying everything from the images folder to var HTML images.

```
$ mv /tmp/images/* /var/www/html/images
```

This images folder is connected to the EFS file system. So this images are going into that file system. So it's no longer the folder on your local hard disk. It is the EFS mount point. Now let's restart httpd service.

```
$ systemctl restart httpd
```

And now if you refresh the browser the images should be back. And this time these images are coming from the EFS file system, it's not on our hard disk.

And this whole exercise is free. The file system size is very small, less than five GB. It comes under free tier, so do not worry.

The last thing that you need to do is create the image AMI of this instance, so we can use it in later lectures.

So your instance is connected to EFS mount point, click `Actions -> Images and template -> Create image`.

I'm naming it as `InnerPeaceEFS` because it has the EFS mount point connected to this. And whenever I launch instance from this AMI, it will automatically go and connect to the EFS file system, click `Create image`.

Okay, wait until this AMI creation is completed. Go to the AMI section. We can create a launch template also for this one. We need to do that actually in the further lectures.

Let's just wait until this AMI becomes into `Available` state, and then you can delete your instance.

Once your AMI is in available state the InnerPeaceEFS, you can now delete this EC2 instance just as a part of a clean up. And for now you can keep both AMI if you want or you can delete the older AMI. I'm keeping both just few lectures and then we don't need those AMIs.

Do not remove your EFS and access point. This comes under free tiers, so you don't need to worry about it, but make sure you watch this EFS video created by AWS. It's pretty simple to use.

Just keep in mind whenever you need a shared file system, you can use Amazon EFS.

So that would be all in this lecture. I will see you in the next one.



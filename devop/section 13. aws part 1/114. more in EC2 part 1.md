# MORE IN EC2 PART 1

Before you launch an instance, let me tell you a general best practice of creating an `EC2 instance`. When you're launching an EC2 instance, definitely you have some requirements.

So the first point is

1. `Requirement Gathering` 

    Gather the requirement. If you get a task like launch a web server with an operating system, so and so storage and compute size, we are going to jot down the requirement. I'll show you how you can collect those requirements. So first part is gather the requirement. Once you have the requirement, then the second point

2. `Key Pair`

    Create key pair. This you can do while launching the instance also, but do it before you launch the instance.

3. `Security Group`

    Then create the security group, which is the firewall, and then finally, 

4. `Instance Launch`

    Start launching your instance. And when you're going through the launch process, you can select your security group, you can select your key pair, and you can make all the decisions based on your requirement.

## REQIREMENT GATHERING 

Talking about requirement gathering, like if you're going to launch an EC2 instance, you may need some information. And mind you, this is not all the requirement gathering that you would be doing. You could be doing less or more based on your requirements. But some general requirement gathering like 

- `Operating System`

    What OS you're going to choose? Okay, so this will tell you which AMI to go with, e.g CentOS, Ubuntu etc.

- `Size`

    RAM, CPU, network, speed, how much do you need? Based on that you'll be selecting the `Instance type`, okay? So let's say you are doing it for a development environment, we can go with minimum.

- `Storage size`

   What you're going to store? First is primarily operating system storage, and then any application that you're running So let's say, we get 10 gigs. If there's a requirement we need 5GB for the web server images

- `Project`

    The project that you're working on. Such kind of information is helpful while tagging the instance.

- `Services/Apps Running`

    Services or applications that will be running. Like for example, you could be running ssh, http, Mysql etc. or any other service.

- `Environment (Dev, QA, Staging, Prod)`

    This for which environment; development, qa, staging, pre-prod, production environment, etc. based on that, so many decisions can be made.

- `Login User/Owner`

    The login user, who is going to log in, who will be the owner? This is used for tagging and also helpful for tracking.

And based on all this requirement and the right process, we are going to now launch an EC2 instance.

## LAUNCH NEW INSTANCE 

Okay, so back to AWS console in EC2. So in previous lecture, we deleted the instance, and you should see this instance in `Terminated` state. Terminated means gone. This instance will be there for 2hrs, but the information will be also gone. If you select this instance and go to `Instance state`, you see you cannot do anything over here.

Now let's launch this `Instance` once again, but this time we'll do it properly.

So first, we are going to create `Key pairs`. Go to `Network & Security`, thn go to `Key Pairs`.

We already have a key. We are going to delete this key. Okay, so the public key is gone and the private key that we downloaded in previous lecture is also now useless. So you better go to your `Downloads` folder and delete that key as well, so we don't have any confusion.

Okay, so let's click on `Create key pair`. Let's give key a name. Now name is extremely important when you're working in projects.

So if you remember the naming convention, we have the `instance` name, the `project` name, the `environment` name, the `key` name is fourth.

Now you can use one key for all your instances or you can use a separate key for every instance. So let's say if you have 100 instances, you're going to create 100 keys. Both are wrong, you should not have one key for all your instances. Also, you should not have separate key for every instance.

Instead you should create a separate key for every environment. Let's say you have different types of environment in your project, `dev`, `qa`, `staging`, `production`. So for every environment, create a separate key.

So I selected a template on tooplate.com, `Moso Interior`, and let's say this is my project name.

So our key name should be in this format 

`[PROJECT NAME]-[ENVIRONMENT]-[REGION]`

Because you might have this instance in different environment. For different environment, you need different keys. You cannot have same key in different environment. Also keys are region-specific. So this key will be only available in North Virginia.

So our key will have the following data

`Name`: `Moso-dev-nvir`

`Key pair type`: `RSA`

`Private key file format`: `.pem`

you can use `.ppk` also if you're using `PuTTY`, but if you're using `terminal` or `git bash` like me, you can use `.pem` format.

Let's also give a `tag` also to this key

 `Name`: `Moso-dev-nvir`

Now click `Create key pair`.

Okay, private key is downloaded with me in my computer and the public key is here on AWS. The public key will be the lock, and the private will be the key to open that lock.

Next, let's go to `Security Groups`, under `Network and Security`

So we have this security group from the previous instance, let's delete it.

Now if you get an error that, you know, you're not able to delete the security group because there is a network interface attached to it, in that case, go to `Network Interfaces`

Like any computer has a network adapter. Our VM also, like we did with Vagrant VM on virtual box where we have bridged adapter, different kinds of adapters, your computer needs a Wi-Fi adapter, ethernet adapter, like that. This EC2 instances also needs network interface.

So when we create the instance, it also creates the network interface, and the security group rule that we apply, the IPs, everything is for the network interface. That network interface is connected to the instance. So if you see any network interface over here select it, go to `Action` first and try to 'Detach', and then after that click on 'Delete` to delete that network interface.

Go back to `Security Groups`. and then click `Create security group`.

The `Security Groups` should follow this naming convention 

`[PROJECT NAME]-[SERVICE TYPE]-[ENVIRONMENT]-sg`

So now let's give security group a name 

`Name`: `moso-web-dev-sg`

`Description`: `moso-web-dev-sg`

So the project name `moso`, followed by, `web`. Now this is for web servers, so that's why I'm giving the name `web`.

The `Security group` case is also similar to `Key pair`. You can use one security group for all your instances or you can have separate security group for separate instances. Again, both are wrong.

You should divide the security group based on your environment and then the type of service. 

Let's say all web servers, you're putting it in one security group, and those instances or those web servers are for dev environment. According to that, we're giving the naming convention.

Now if you're trying to skip naming convention and give whatever you want, trust me, it's a very, very bad practice. You're going to suffer a lot in real time due to this. Right now I cannot tell you the whole story, it will only come with experience. Use proper naming convention.

Now in security group, you have two kinds of rules. Security group is firewall. So in any firewall,you have
1. `Inbound rules`: traffic coming towards your instance

2. `Outbound rules`: The traffic going out of your instance or of your server

So I have seen this many people when things are not working, when they don't understand the firewalls. What they do is they add rule 

`Type`: `All TCP` or `All traffic`

`Source`: `All Ipv4`

And then create a second rule

`Type`: `All TCP` or `All traffic`

`Source`: `All Ipv6`

This means allow all traffic from any IPv4 and IPv6.

I'm not kidding, in some very sophisticated projects also I have seen these things.

So this rule simply means there's no restriction. There are no gates, no doors, no windows. Anybody can come to the party. It's like that.

Now before we move ahead and add these rules, let's take a look once again.

## SECURITY GROUPS

- A security group act as a firewall that control the traffic for one or more instance.

    This is a firewall, and a virtual firewall that controls the traffic for your instance. You can have one security group connected to multiple instance or you can apply one security group rule to multiple instances.

- You can add rules for to each security group that allows traffic to or from it's associated instances.

    And these are basically rules for your incoming traffic and your outgoing traffic.

- Security group are stateful

    They're stateful, so if you are saying for inbound traffic, you're allowing port 22 for SSH, the same outbound rule be will be automatically apllied, you don't need to mention it.

So two kinds of rules in security group,

1. `Inbound rules`: traffic coming towards your instance

2. `Outbound rules`: The traffic generating from of your instance or of your server and going out

So if you don't know firewalls, think of them as the watchman or the gatekeeper who has a register, and from the register will be checked who is allowed to come in and also who is allowed to go out, and where are you coming from.

Watchman are usually guard for parties, so if you're coming from a particular place and you want to go in, it will be checked in the register, that, is there entry for you. If it's there, you are allowed in. And similar way, if you're going out of the party, are you allowed to go out? That will be weird, for humans to do that. But, you know, the outbound rules are set sometimes to increase more security.

So let's set proper rules. We will remove the previous entries, and add specific rule.

One thing we need is to `SSH` to this instance. So you can select type `SSH` and it'll select the default port as `22`

`Type`: `SSH`

`Source`: `My IP`

or you can say `Custom TCP` rule port `22`. 

`Type`: `Custom TCP`

`Port range`: `22`

`Source`: `My IP`

So choose any one.

Now you do not want people to do SSH to your instance except those who are managing it. So mostly it'll be your IP, like your corporate office IP. 

`Source`: `My IP`

And when you're connected to that network, you can just do `My IP` and it'll give you that public IP. And in corporate networks, the public IPs will be static.

Okay, so for now, we'll keep this rule. Again, once we deploy our web service, we'll come back and add the rule for port 80. Do not add rules in advance. We know there is SSH, we are going to do SSH, so that's why we're adding this rule. We are not installing anything on that. There's no web service running, so there's no point in adding any rule. Once we do that setup, then we will add the rule.

The outbound rules says all traffic can go anywhere.

`Type`: `All traffic`

`Destination`: `Custom`

Now if you make any change in the outbound rule, you will not have internet connectivity to your instance. Plain and simple, because the internet traffic goes out on various different ports. Most of the times, this is handled by a proxy.

So here, outbound rule will be given for the proxy IP, and the proxy server will handle the internet traffic. But for now, we have to keep it as it is. All traffic allowed to anywhere. Do not touch outbound rule ever until unless I tell you to do because we'll need lot of internet stuff in this course, for our instance, of course.

Okay, now that is all. You can give the `Tag`. I'm going to give the Name tag same name as the security group, try to give more tags in real time, so it makes more sense.

`Name`: `moso-web-dev-sg`

Now, click `Create security group`. We now have the key pair and we have the security group. Now let's go ahead and launch our instance.

So I'm going to go to `Instances` and click `Launch instances`.

I'm going to give four tags over here.

`Name`: `web01`

`Project`: `Moso`

`Environment`: `Dev`

`Owner`: `DevOpsTeam`

Now I usually use these tags, if no naming conventions are mentioned, but if naming conventions are mentioned, or if there is a standard in the organization, you better follow that.

Now, `Resource types`, I want to tag my `Volumes` and `Network interface`, so I can identify, which project  volumes and network interface belongs to, who is the owner and for which instance it's connected to. We'll see about volumes in later lectures.

Now scroll down. For this `AMI`, we are going to go with `Ubuntu`, the latest one, `Ubuntu Server 24`, free tier eligible. So just select it. You don't need to worry much about this one.

Scroll down, `t2.micro`, we will keep that as the instance type.

`Key pair`, we have already created the key `Moso-dev-nvir`, and we are going to select that one.

See, it's easy to understand that this key can be used for this instance, right? This is for Moso project dev environment, North Virginia. We can simply select this key.

`Network settings`, click `Edit`, under `Security group`, select `Select existing security group`, in the drop down, we can select our security group.

Let's say you have some 50 security group and if you don't have proper naming convention, how hard it'll be to select, right? So that's why I say use proper naming convention.

`Volume`, we will keep it as it is. As I said, we are going to talk about this in later lecture.

Now we are not going to put any `User data` commands over here. No user data commands or script. Simply launch the instance `Launch instance`

Once the instance is launched we're going to SSH and then execute our commands. Okay, let's SSH to our instance. Let's select the instance.

Okay, so instance `web01`, which is in the running state right now, copy its public IP. I'm going to open Git Bash, or terminal for macOS, 

```
$ ssh -i /Downloads/Moso-dev-nvir.pem ubuntu@[PUBLIC IP]
```

The username for Ubuntu AMI, official Ubuntu AMI is `ubuntu`. Hit `Enter`.

Now that you're logged in, let's switch to root user.

```
$ sudo -i
```

And let's execute our command to install `apache2`, 

```
$ apt update && apt install apache2 -y
```

In Ubuntu, when you install the service, most of the time, it will be in running state anyways, you don't need to do anything.

```
$ systemctl status apache2
```

It's active running. `q` to quit.

Okay, let's download the template. So use Brave browser because it will, you know, avoid too many ads. So find your favorite template or the project name that you have selected, we need to get the download URL. So hit `f12` if you're using Brave browser. Make sure you are in the `Network` tab and click on the `Download` link, click on the `.zip`, in the `Header`, in the `Requested URL`, you should get the download URL, copy this URL.

```
$ wget [TOOPLATE URL]
```

After downloading the zip file, let's unzip it.

```
$ apt install unzip -y

$ unzip [TOOPLATE FILE.zip]
```

Now let's copy recursively everything from this folder

to /var/www/html,

```
$ cp -r [TOOPLATE FOLDER]/* /var/www/html
```

and then we'll restart the apache2 service.

```
$ systemctl restart apache2
```

Okay, we'll check the process, apache2.

```
$ ps -ef | grep apache2
```

It's running.

We'll see the content /var/www/html.

```
$ ls /var/www/html
```

Content is already there.

Let's check the port number 

```
$ ss -tunlp | grep [APACHE2 ROOT PID]
```

Okay, so the port number 80 is allowed from anywhere. I think you know where I'm getting at, right?

So now let's access our web01. Let's take its public IP. Let's put it in the browser. We know by default. it goes on protocol HTTP and port number 80, right?

So when we hit `Enter`, we should see our web service, but we won't...Why? You remember. That's right, `Security group`.

Security group allows only port 22. Let's go back to our `Security group`. Select the running instance `web01`, go to `Security`, then `Security group` and click `Edit inbound rules`. Again, not outbound, inbound rules.

So only 22 is allowed. We are going to add new rules 

`Type`: `Custom TCP`

`Port range`: `80`

`Source`: `Anywhere IPv4`

And also

`Type`: `Custom TCP`

`Port range`: `80`

`Source`: `Anywhere IPv6`

Now I know I said allowing from anywhere is bad, but see this, we are hosting it for public, right? In real time, yeah. When we host a website, if you are hosting it for public, then of course we need to allow it from anywhere.

So add those rules. Click , `Save rules`, and then let's refresh and we should see the website.

Okay, so that is all in this lecture.

Next lecture, we are going to see more settings and features of EC2 instance.

So join me the next one.




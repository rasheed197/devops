# ELB HANDS ON PART 2

So now let's launch two EC2 instances web01 and web02 from the template. And then create the target group and load balancer.

So let's go to `Launch templates`. Select our template `Action -> Launch instance from template`.

And I'm going to add two instances over here `Number of instances`. Let's scroll down go to `Resource tags`, and here we're going to name it as `web00`.

So both instances will have same tag and everything will be same. After the launch we can change the name value tag. Let's say `Launch instance`. 

Okay let's go back to `Instances`. So the first one I'm going to change the name as `web01` and the second one as `web02`.

So let's go to `Load balancing` section. Go to `Target groups` first. So target group basically is just group of instances with health check. So you can register instance in the target group. You can also deregister from it, and load balancer is going to redirect the traffic to the target group which contains your instance.

So let's click on `Create target group`. You can have target group of `Instances`, `IP addresses`, `Lambda function` and even `Application load balancer`. So one load balancer can route request to other load balancer.

We're just going with `Instances` first. So instances protocol `HTTP` because we are running HTTP service in our instance, and that runs on the default port `80`. If you use Non-default port like 8080, 90, anything else, any other service you're using, then make sure you update the port number over here.

Scroll down to `Health check`. So there is this feature in the load balancer that it routes the request to the healthy instances and does not route the request to unhealthy instance. But the question is how does it know whether the instance is healthy or not? Well, that, it knows through the health check. So target group can run periodic health check on the instance to check your service, and that it does by checking the `Health check protocol`. So there's two option `HTTP` and `HTTPS` health check path.

So in our instance we run the Apache Service and it is serving the website from the default folder `/var/www/html`. But let's say you're serving a website from a non default folder, like default is `/var/www/html`, inside that you have other folder like `/images` or `/videos` or something like that, or maybe you created another folder inside that innerpeace, and after giving the endpoint you need to give  `/innerpeace` to access the website or the web page, then you need to give that non default path.

So `/` here anyways means `var/ww/html`,we have website running from there, so we don't need to mention anything over here.

Let's check the `Advanced health check`, so HTTP default port is 80 and that's what it's selected over here `Traffic port`. But if you are using Non-default port then you need to say `Override` and mention the port. Let's say for example 8090 your web service is running on a non-default port, you need to mention that, but for us it's going to be the default port, which is 80.

Next setting is `Healthy threshold`, it says `5`. So five time it needs to return the healthy status. That means it's going to access the HTTP protocol, it's going to check the site on port 80 if it's healthy. And that needs to be done five times, then only it's going to declare the instance as healthy. But we are going to reduce that, and let's reduce it to `2`, because five times it's going to take a little bit of extra time.

`Unhealthy threshold` it says `2`, now what happens if the instance is unhealthy, it's going to check two times. If both the times it is showing unhealthy, then only it is going to declare the instances unhealthy and two is minimum, one is definitely not recommended because sometimes due to high load and all the service does not respond and it goes unhealthy, and in the same moment, if the health check is done and the instance declares as unhealthy, that will be bad, right? So mostly it will be two or higher.

Always `Timeout` is `5` seconds, it's gonna wait five seconds before it goes to the next unhealthy health check. And this is going to happen all in the `Interval` of `30` seconds.

So it's checking the healthy threshold for five times. So it's going to do the health check, then it's going to wait 30s then again go to the next health check then wait 30s. 

the interval `Success codes` it is expecting is `200`. 200 is default healthy success code, HTTP success code default is 200. So we're going to keep that as default.

Now I have spent some time over here to go through each and every option over here. We are going to make changes to this option in the projects when we set up the project. 

It's important for you to understand, I have seen many places where the services are live, healthy, running, but because of the misconfigured health check, the instances are unhealthy. So people waste time in fixing the service of the instance rather than focusing on the health check. So make sure you know the service, what protocol, what port number it is running, what is the health check path or what is the path where you are serving the traffic? If you know all that, then you can configure the right health check.

So for example, if we take any of this instance public IP, and then in the browser we do `http://[public ip]:80`.

So port `80` is what goes by default right, so we don't need to mention the default port if you give HTTP, that anyways means the port 80 default.

If you have a non-default port you will give something like this `http://[public ip]:8090`, you know like you have 8090 port.

And if the website path is not the root directory, you can give `http://[public ip]:80/` and you can give the path, let's say for example `http://[public ip]:80/images`.

So once you know all this, the protocol, the port number, and the path you can configure the right health check.

Okay. Let's keep everything default except the `Healthy threshold`. I'm going to reduce it from `5` to `2` and also we need to give the `Target group` a name.Naming it as `innerPeace-TG` and then click `Next`.

Now you can register the instance now or you can do it later. Also I'm going to select both the instance that we have created, web01 and web02, and you need to click on this button `Include as pending below`.

Make sure the port number is 80 over here which is the default port for our Apache service. They both are in the same zone .`us-east-1d`. Okay, once again you need to have these instances over here in the `Review target` section. So you need to click on `Include as pending below` and make sure they're here in `Review target`, and then click `Create target group`.

Okay. So the target group is created. Now let's go to the `Load balancers` and say `Create load balancer`. So we have `Application load balancer`, `Network load balancer`, `Gateway load balancer`, and `Classic load balancer`.

The classic load balancer is really very easy to create and run, just you don't need target group. In classic load balancer you just create the load balancer add the instance and done but doesn't give too many options.

For application load balancer, HTTP and Https only, and that's what you want. Most of the cases you will have http and https traffic and it's a pretty decent load balancer, very easy to configure, very easy services to set up. And mostly it is used to serve the internet traffic. So we are going to go with the application load balancer. Click on `Create`.

Let's give it a name `innerPeace-ALB` application load balancer. There are two `Schemes`; `Internet facing` and `Internal`. As I said we are going to solve the internet traffic. So we're going to keep it as `Internet facing`.

But if you want it for some internal services that are used by some internal application, let's say you have a service running in an EC2 instance that wants to access some backend service. So for those backend services you can have an internal load balancer. But we are going to keep internet facing.

Scroll down, you can see here `Availability Zones and subnets`. So our instances are in us-east-1d. But usually you will have instances distributed among multiple zones. So you can select those zones or you can select just all the zones. Now each zone can have multiple subnets. And all this we're going to talk about in AWS part two when we cover VPC. For now just understand this is just a network. VPC is the main network, and in that you have subnet, and one zone can have multiple subnets. We just have one, an these are the default subnets or default network in your AWS account in North Virginia region and I'm going to select all of them, just to show you, you know, you can have the load balancer that can route traffic to all these zones in a region.

Okay. Now the security group, the load balancer should have its own separate security group. This is not the instance security group, this is the load balancer security group we are talking about. So we don't have security group created already for load balancer. So let's create. We can click on this link `Create new security group` and let's give it a `Name` and `Description`, `innerPeace-ELB-SG`. That makes some sense, have proper naming convention.

`Inbound rules`, now we are going to serve the internet traffic, we need to give here `Custom TCP`, port `80` allowed from `Anywhere IPv4` and any `Anywhere IPv6`.

So in the project we are going to see how to set up the secure connection https port 443. In such cases, you need to also have the port 443 here. But for now, we just have port 80 from anywhere.

So give that rule and make sure you have edited inbound rules and not the outbound rules. And let's click `Create security group`.

Let's go back to the `Load balancers` page, refresh this, and in this you should find the `innerPeace-ELB-SG`, select that and uncheck the default one, we don't want the default security group.

So once again we have given name to the load balancer internet facing, we selected all the zones, we selected the security group. 

And now the `Listener and routing`, so by default it is going to listen on port 80. That is the internet traffic coming towards the load balancer. Once it receives the traffic where should it redirect `Default action`. So here you need to select the target group. In target group we have our two instances that serves the traffic on port 80 on HTTP protocol. Okay.

So you can add multiple listeners. As I said, we just have port 80 for now.

In project. We are also going to see HTTP 443. If you click here on `Add Listener`, you can say here HTTP 443, you can select the target group, but along with this you need to give the ACM certificate that we're using for encryption. Anyways that will be seen in the project. Let's remove the 443, but just you should know we can add we can add multiple listeners.

Along with the load balancer setting, there are a few other services that you can integrate with the load balancer like CloudFront. Again we'll see that in the project. There is `WAF`; `AWS Web Application Firewall`.

This is different than our security group firewall. This works at the application level. It prevents the common attacks like DDoS, cross-site scripting and many other things, you can deny traffic from a particular location, IP addresses, you can block some zones, you can do many more amazing things, but this works at the application level, not at the port and protocol level. And it's not free.

But my recommendation is just go ahead and take a look, collect some information on web application firewall, especially AWS WAF. When you work with the security team, it will be helpful. Now, scroll down and click `Create load balancer`.

Okay, so we should see the load balancer created, but it takes some time, it says provisioning.

Let's wait a little and refresh until it's `State` says `Active`.

Once it's active you can click on this load balancer, and you should see here the `DNS name`. That's the end point to access the load balancer, which should route the traffic to the instance in the target group.

So, let's go and check this endpoint in our browser, it should not return anything.

AWe got `504 Gateway Timeout`, there is one problem in our configuration not the load balancer configuration, something else if you can figure out.

Think about it, we are accessing the instance on HTTP port 80. And then load balancer routes the request to the instance on port 80. So why do we get an error. For any 500 error it's usually the server side problem that is behind the load balancer. Your servers have some problem.

So let's go to the target group, from the target group we  see the instance they are unhealthy, two instances unhealthy. Why?

I mean I can access from the IP address right? No problem. It works. The same thing I configured in the health check. So what is in between the health check and the instance that is blocking the The traffic.

Get it now. Okay, once again, I am able to access the instance, but the load balancer is not. Okay, let's check the target group of the instances. So load balancer is routing the traffic to the instance on port 80. Let's go to the instance security group, and let's click on `Edit inbound rule`. So we see port 80 is allowed only from `My IP` and not allowed from the load balancer. Right.

We're going to delete that rule, and we are going to add one more rule. We can just say `HTTP` takes `80` by default, `Source: Custom` and here we are going to type `sg` and let's find our `innerPeace-ALB-SG`. So when we select that then this rule says any traffic coming from this security group on port 80 is allowed.

Yes. You can mention in the source Security Group. Also, I'm just giving some description over here. This always helps `Allow 80 from ALB`. So that is the application load balancer security group ID.

We save the changes, but we need to wait for few minutes until the instance are healthy. In the target group we see the instance will be unhealthy. It's going to take some time to pass the health check.

Once the instance are healthy over here, load balancer will start routing the traffic.

So in less than two minutes the instance are healthy, so it conducted two health check in an interval of 30s.
Both return as healthy, so instance declared as healthy. And now we should be able to access it from the load balancer. And it's working.

Let's take a quick look at the load balancer and few settings. So especially at the target group site. So in the targets of the instance you can register and de-register the instance. When you have group of instances like this you can conduct maintenance on them one by one, maybe updating the package or OS update or any other changes you want. You don't want user traffic to get disrupted, so you can select the instance and you can deregister the instance from the group, conduct your maintenance, and then you can register it back.

In the load balancer, you can add or remove listener, you can add or remove target groups, you can change the security group, you can change many attributes of a load balancer.

So before you delete and do the cleanup, make sure you go through the different settings. Some of these settings we are going to use in the later lectures, like changing the port numbers, the security group,  secure Https traffic with the certificate and few stuff.

Once you are done doing all that, then you can do the cleanup, and finally you can have the inner peace.

So first delete the `Instances` in the cleanup process. We have the launch template, we can launch them anytime we want. So `Instance state -> Terminate(delete) the instance`. Go to the `Target group` and remove the target group `Action -> Delete target group` okay it's still in use. Let the instance get deleted okay.

We can delete the load balancer first if you want. So select the load balancer `Action -> Delete load balancer`. Now try the target group once again.

You don't really need to delete the target group. You can keep it. There are no charges for this, but let's do the cleanup.

Okay, now let's go to the `Dashboard`. Make sure you refresh and check everything. You should have zero running instances. Two instances that will should be in the terminated state, zero load balancer, zero elastic IP address, and zero volumes. You should see one snapshot, that is coming from the AMI.

So if you go to the AMIs, select this `Owned by me`, and you should have the AMI.

And you should have a snapshot used by that AMI. You cannot delete this snapshot. It is tied to the Ami. And keep the AMI for some time, because we are going to use it in the upcoming further lectures. And once we are done, I'm going to show you how you can deregister the AMI and then delete the snapshot.

See you in the next one.



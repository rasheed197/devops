# CLOUDWATCH HANDS ON

All right. So we're going to see one very simple exercise with CloudWatch monitoring. And we're going to conduct some tests or checks on the EC2 instance.

So we need to have an EC2 instance. And we already have launch template. So we can quickly launch the instance. So I'm going to just go to `Launch template`. Select the launch template and say `Action -> Launch instance from template`.

Just scroll down and change the instance key name. I'm going to name it as web012, and give some distinct name, because we're going to get a list of even terminated instance, we need to find our instance from that. So give some unique name that you have not given already and just say launch instance.

Let's take a look at the instance, go back to the `Instances`, select that web012 instance, and here you should see a `Monitoring` tab.

So we're going to take a look at the CloudWatch service in a moment, but let's check these graphs that are created by CloudWatch service. Every section over here represents a metric or a check. So like `CPU utilization`, we just launched this instance, it's not going to be anything, we need to wait for some time.

By default it collects the data for every five minutes on EC2 instance. If you want, you can enable `Detailed monitoring` which collects the data every minute, but that is not free. But in any case, I am going to enable that, you don't need to enable it, you just need to wait a little longer.

So I'm going to enable detailed monitoring, I'll click on `Manage detailed monitoring`, and I'm going to enable `Detailed monitoring`, and click `Confirm`.

Now CloudWatch is going to check every minute, every minute it's going to collect the information on these checks on these metrics. So by default on EC2 instance it collects CPU Utilization, Network in in bytes, Network out in bytes, Network packets in, that means how many network packets are coming in and network packets going out, CPU credit usage and CPU credit balance. So these are default monitoring done by CloudWatch on EC2 instance.

And as we progress in the course, you're going to see many different services of AWS. Each service has its own default metrics that CloudWatch collects. If you get a little deeper into this you can add custom metrics, also, you can create your own metric, but usually organization prefer using their own monitoring tool for custom metrics.

Okay, now I recommend you take some break. Let this graph collect for a few minutes, 15-20 minutes or maybe more, and then you come back and then you can refresh the page and you should start seeing this graphs like this, the CPU utilization. You can also click on any of the graphs and you should get a larger visualisation.

And then we're going to install stress, and then you're going to take a break once again. But for now, let it collect some information. By the time I'm going to install a tool called stress, you can do it now or you can do it after the break.

So I'm going to log in to this instance. So let me go to the `Security group` of this instance click `Edit Inbound rule` ssh 22 from my IP okay. Let me go back to the instance, and get its public IP.

And I'm going to do ssh 

```
$ ssh -i [private key path] [username]@[IPaddress]
```

Since this is Amazon Linux operating system the username will be `ec2-user`

So let me show you the OS also 

```
$ sudo -i

$ cat etc/os-release
```

If you're using another OS like ubuntu, then the step of installation will be different.

```
$ dnf install stress -y
```

If you're using ubuntu, you can use 

```
$ apt update 

$ apt install stress -y
```

Now this tool stress is used to put different kinds of load on the computer like CPU, memory, disk IO.

Let's just run the stress command.

```
$ stress
```

See, it says stress imposes certain types of compute stress on your system.

This is used to test your operating system performance. We are using it so we can see the graph going up and down, and then we're going to set an alert in CloudWatch which should send notification when the CPU utilization is high. So if you want to spike the CPU you have to say `stress -c --cpu N`, and `N` is the number of this process that it is going to run.

So if I say.

```
$ stress -c 4
```

It is going to start stressing our CPU. It's going to spawn four workers spinning on sqrt() function. Okay.

So I'm going to do <kbd>ctrl</kbd> + <kbd>c</kbd> to cancel this.

We want to run it for a certain period `--timeout`, and then close it, and then run it again and then close it like that.

So I'm going to write a script, but before that, let me show you how we can run this with the timeout.

```
$ stress -c 4 -t 5
```
We want it to run for 5 seconds.

I have asked ChatGPT `give me a bash script to run below command for random interval for random amount of time just make sure it runs for more than one minute: stress -c 11 -t 5`

So sometimes it will run the command for one minute sometimes more, the interval will be also random. So copy the code and paste it in a file `stress.sh` Make it executable

```
$ chmod +x stress.sh
```

So we want to let it run in the background 

```
$ nohup stress.sh &
```

So `&` puts this command in the background and `nohup` will detach it from this shell. So even if you close this session it will be running it.

Okay, I'm going to put this script in the lecture resource. If you don't want to get it from ChatGPT, you can get it from the lecture resource and run it.

Now if I run the top command.

```
$ top
```

I should see the load going up and down. The CPU utilization `%Cpu(s)` is going up and down and it's increasing the load, the `load average`.

So let's keep it running for 5-10 minutes. And then we're going to take a look at the graph.

Okay. So after waiting for some time I'm going to open the CPU utilization graph. I'm going to refresh the graph.

Okay. Now you can start seeing the graph forming there. This is for every five minutes, you can also check for every minute okay. Now ours is running randomly right on random interval of time and then breaking then again running.

Now see the load going up and down is not a big deal. Now I'm specifically talking about CPU utilization. It's not a big deal that happens in real servers. The problem is when the load goes high and stays there for a long time, like your blood pressure, you know, you do some workout, you take some stress, you climb stairs, the blood pressure goes up. But then when you take rest, it goes down. So that's not a problem. The problem is when it goes up and stays there for a longer time. Similar way on the computers also, for CPU utilization or memory or disk. The stress on that resource going up and staying there for a long time, indicates that there is a problem.

And now you cannot manually monitor all the servers. So there should be notification system if something like that happens like CPU going high, staying there for a longer time, let's say five minutes, notification should go to the monitoring team, to the concerned team, and they should look into it and escalate it if it's required.

So that's what we are going to do in this lecture. We are going to set an alert for CPU utilization that if it goes up, stays there for five minutes then it should send a notification.

So now let's go to `CloudWatch` service, and you need to go to `All alarms`, and you say.

You need to first select the metric `Select metric`. So we are targeting CPU utilization of our own instance.

So click `Create alarm` and find `EC2`. We are setting up for EC2. Now you see there are a few other options. You have EBS, you have S3, you have Logs, Application load balancer. Now these are the services that I have used in this account in this region.So when you use a service CloudWatch will set some default metrics for that service, like EC2, We have seen we have CPU utilization and network packets for EBS, there will be something else for S3. So whichever service you use, you have different kinds of metrics for every service and you can set alarm for them.

So we are going to do it for EC2. So select `EC2` and we are going for `Per-instance Metrics`.

We should search it with the instance id, copy your instance id and paste it there, select CPU utilization of your instance, and click on `Select metric`.

You can see the graph. You see the `Metric name` is CPUUtilization. You can rename it if you want and you can change the instance id `InstanceID`. That means that once you set the alert you can change the instance ID you can select different instances also. So `Period` is `5 minutes` you have lesser also there in dropdown. So you can keep it 5 minute I'm going to reduce it to 1 minute.

So I'm going to say for a period of one minute if it's greater than or equal i.e `Greater/Equal` to I'm going to say `60`, I'm just giving a random number. It really depends on what service you're running when your instance crash, if the CPU utilization is, let's say 90 for five minutes or more than five minutes, the instance crashes. Or if it's a danger to your service, your service can crash. So based on that, all that information you need to decide the right value and that comes with experience. It comes with time that you spent with your application, and a real monitoring team should be there, who knows what they are doing.

Your job as a DevOps is not to set monitoring. Yes, of course you can work with setting up, monitoring, automating the process, but there there should be 24/7 monitoring team who are working supporting these activities for production.

So we set the metric for greater than or equal to `60%` for a period of one minute, then click `Next`.

Now `Alarm state trigger` i.e if those condition matches right, if it's 60% or more for than minute then what is it, we are saying it is `In alarm`. You can decide if it's `Okay` or `Insufficient data`.

Now I want to set an alarm. So I'm saying yes, if it is or goes above 60 for more than one minute, it is an alarm. So this is for notification right.

So now you have to send the notification. If you have set the billing alarm in the prerequisite lecture, you should see your SNS topic over here. Otherwise, if you don't see you can say create new topic, you can give topic a name e.g `innerpeaceNotification` and put your email address.

So I'm creating a new one. I have given a name to the topic and I have given an email address and I say `Create topic`.

So when the condition matches, when it's in alarm state it is going to send notification with this topic `innerpeaceNotification` to the email address.

Now there are other actions also you can use, there are interesting ones like `EC2 action`. If it's `In alarm`, what do you do? Do you `Stop this instance`, or `Terminate this instance` or `Reboot this instance`. 

I have personally used this. I have used `Lambda action` also, but it depends on the use case. If it's a requirement, if the load is high, maybe reboot the instance. Maybe there is some bug that needs to be fixed, and the only solution for now is to just reboot the instance. So you know you can do that automatically through CloudWatch. That's automation.

So I'm just going to remove this `EC2 action`. Not going to keep it And just keep in mind there are many other action, not just sending notification, you can take some action. Also, you can have a lambda function, a Python script that will do something if the load is so and so.

Okay, we're going to see that all those things later. For now we're just sending a notification, click `Next`.

`Alarm name`, I'm going to say it is a `Warning`. So usually there are different thresholds depending on your organization. Let's say 60 is `Warning` and 80 is `Critical`, below 60 or 50 is `Okay`.

I'm saying just `Warning | High load on Inner Peace web server` or `Warning | High or high CPU utilization`.

You can  give some description over here `Alarm description`. But I'm just keeping it empty. And I'm going to say `Next`.

So see the bar is very high above 60. And our load is not spiking and not going over there. We need to stress our system more. So let's set the alarm and then we can do that. So I say `Create alarm`.

If you have set a new topic you'll get `Subscription Confirmation` email in your email account. Make sure you click on `Confirm subscription`.

Go to `All alarms` So first you will see `Insufficient data` in the `State`, then it will start collecting the data in a few minutes. So by the time it happens let's put some more stress.

First terminate the previous stress process

```
$ ps -ef | grep stress.sh

$ kill [process root id]
```

Now I'm going to make some changes and add more CPU and more timeout to `stress.sh`.

```
...
stress -c 35 -t 62
...
```

Then I'm going to run the file in the background 

```
$ nohup ./stress.sh &
```

Now I'm going to let it run for a few minutes until I get the notification, until it's in `In alarm` state.

Okay, after waiting for some time and now it's in `In alarm` state. Click on it and you should see the graph. Let's make it `Custom` and set it to `10` minutes.

You see that it stayed above 60 for over a while, the CPU utilization graph is spiking and staying long. Now for me it's every minute. So I should have got the notification already, it will also contain the link for that CloudWatch graph.

Now this whole exercise comes under free tier because ten alarms you can create freely. Just make sure you keep default five minutes monitoring instead of detailed monitoring, just need to wait a little longer, that's all.

But this whole exercise should give you an idea of the notification system. Why do you need notification? What is an alarm? What is a metric or check?

CloudWatch is an amazing service. This is just a very small glimpse of CloudWatch. You can do many things. You can do monitor logs which we're going to see in AWS part two. And now it comes with the AI operations.

Also you can conduct investigation on why some metrics are going high or low. So we will be doing auto scaling group exercise in upcoming lectures. And this information that we have collected in this lecture about metric CPU utilization, all this will come in handy.

So take your time, play around, take a look at different settings. Ten alarms are under free tier so feel free to create more alarm. You can make changes, you can say if the load goes down, this alarm is in okay state. You can change that. You can do a reverse.

And once you are done, you can delete the instance. You can delete the alarm even if you keep the alarms, no problem. But even after deleting the instance, the alarm will be there. There won't be any data coming from the instance, but alarm will be there so you can delete the alarm also if you're not using it.

But just make sure you do clean up once you're done with this activity. Okay, so that would be all in this lecture I will see in the next one.


 